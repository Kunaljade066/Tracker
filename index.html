<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>QA Tracker ‚Äî Multi-Device Safe</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Space+Grotesk:wght@500;700&display=swap');
*{box-sizing:border-box;margin:0;padding:0}
:root{--bg:#0f172a;--surface:#1e293b;--surface2:#162032;--border:#334155;--text:#e2e8f0;--muted:#94a3b8;--dim:#64748b}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;transition:background .25s,color .25s}
body.light{--bg:#f1f5f9;--surface:#ffffff;--surface2:#f8fafc;--border:#e2e8f0;--text:#1e293b;--muted:#475569;--dim:#94a3b8}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:var(--surface)}::-webkit-scrollbar-thumb{background:#475569;border-radius:3px}
input,select,textarea{font-family:inherit;outline:none}
.inp{background:var(--surface2);border:1.5px solid var(--border);border-radius:8px;padding:9px 13px;color:var(--text);font-size:14px;width:100%;transition:border-color .2s}
.inp:focus{border-color:#3b82f6}
.btn{cursor:pointer;border:none;border-radius:8px;font-family:inherit;font-weight:600;transition:all .15s;display:inline-flex;align-items:center;gap:5px;white-space:nowrap}
.btn:hover{filter:brightness(1.1);transform:translateY(-1px)}
.btn:active{transform:translateY(0)}
.hidden{display:none!important}
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.82);z-index:300;display:flex;align-items:center;justify-content:center;padding:16px}
.modal{background:var(--surface);border-radius:16px;padding:26px;max-width:660px;width:100%;max-height:93vh;overflow-y:auto;border:1px solid var(--border);box-shadow:0 24px 64px rgba(0,0,0,.5)}
.tcard{background:var(--surface2);border-radius:10px;padding:11px;border:1px solid var(--border);transition:all .18s;margin-bottom:8px}
.tcard:hover{box-shadow:0 4px 18px rgba(0,0,0,.35);border-color:#475569}
table{width:100%;border-collapse:collapse}
th{padding:10px 13px;text-align:left;font-size:11px;color:var(--dim);font-weight:700;border-bottom:1px solid var(--border);background:var(--bg);letter-spacing:.5px;text-transform:uppercase}
td{padding:9px 13px;border-bottom:1px solid var(--border);font-size:13px;vertical-align:middle}
.tpill{font-family:'Space Grotesk';font-size:12px;font-weight:700;padding:3px 9px;border-radius:20px;display:inline-flex;align-items:center;gap:4px}
.tpill-idle{color:#64748b;background:#64748b18;border:1px solid #64748b33}
.tpill-run{color:#059669;background:#05966918;border:1px solid #05966944;animation:pulse-green 2s infinite}
.tpill-pause{color:#d97706;background:#d9770618;border:1px solid #d9770644}
@keyframes pulse-green{0%,100%{box-shadow:0 0 0 0 #05966933}50%{box-shadow:0 0 0 4px #05966900}}
.tbtn{cursor:pointer;border:none;border-radius:6px;font-size:10px;font-weight:700;padding:2px 7px;font-family:inherit;transition:all .12s}
.tbtn:hover{filter:brightness(1.15)}
.tab-btn{cursor:pointer;padding:7px 14px;border-radius:7px;font-weight:500;font-size:13px;transition:all .18s;border:none;background:transparent;color:var(--muted);font-family:inherit}
.tab-btn.active{background:#1e40af;color:#fff}
.tab-btn:hover:not(.active){background:var(--surface);color:var(--text)}
.badge{display:inline-block;padding:1px 7px;border-radius:4px;font-size:10px;font-weight:500}
.cloud-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:4px}
.cloud-ok{background:#059669}.cloud-err{background:#dc2626}
.cloud-sync{background:#d97706;animation:blink .8s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
</style>
</head>
<body>

<div style="background:var(--bg);border-bottom:1px solid var(--border);padding:0 18px;position:sticky;top:0;z-index:100">
  <div style="max-width:1340px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;height:58px;gap:8px;flex-wrap:wrap">
    <div style="display:flex;align-items:center;gap:10px;flex-shrink:0">
      <div style="background:linear-gradient(135deg,#3b82f6,#06b6d4);border-radius:10px;width:36px;height:36px;display:flex;align-items:center;justify-content:center;font-size:18px">üß™</div>
      <div>
        <div style="font-family:'Space Grotesk';font-weight:700;font-size:15px;color:var(--text)">QA Tracker ‚Äî Multi-Device Safe</div>
        <div style="display:flex;align-items:center;gap:6px">
          <div id="todayLabel" style="font-size:12px;color:var(--muted)"></div>
          <span style="font-size:11px;color:var(--dim);display:flex;align-items:center">
            <span class="cloud-dot cloud-ok" id="cloudDot"></span><span id="cloudLabel">Connecting‚Ä¶</span>
          </span>
        </div>
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">
      <input id="myNameInput" class="inp" style="width:115px;font-size:12px;padding:5px 9px" placeholder="Your name‚Ä¶" oninput="localStorage.setItem('qa_name',this.value)"/>
      <button class="btn" onclick="syncSheet(true)" style="background:#059669;color:#fff;padding:7px 11px;font-size:12px" id="syncBtn">‚òÅÔ∏è Sync (Smart)</button>
      <button class="btn" onclick="loadFromSheet()" style="background:#0e7490;color:#fff;padding:7px 11px;font-size:12px" id="loadBtn">‚¨áÔ∏è Load Fresh</button>
      <button class="btn" id="themeBtn" onclick="toggleTheme()" style="background:var(--surface);color:var(--text);padding:7px 11px;font-size:12px;border:1px solid var(--border)">üåô Dark</button>
      <button class="btn" onclick="openTaskForm(null)" style="background:#1e40af;color:#fff;padding:7px 12px;font-size:12px">+ Task</button>
    </div>
  </div>
</div>

<div id="syncBar" class="hidden" style="background:var(--surface);padding:6px 20px;text-align:center;font-size:13px;color:var(--muted);border-bottom:1px solid var(--border)"></div>

<div style="max-width:1340px;margin:0 auto;padding:18px 18px 30px">
  <div id="statsRow" style="display:grid;grid-template-columns:repeat(6,1fr);gap:10px;margin-bottom:16px"></div>
  <div style="display:flex;align-items:center;gap:8px;margin-bottom:14px;flex-wrap:wrap">
    <div style="display:flex;align-items:center;gap:6px;background:var(--surface);border:1px solid var(--border);border-radius:9px;padding:5px 12px">
      <span style="font-size:11px;color:var(--dim)">üîç Search</span>
      <input id="searchInput" class="inp" style="width:180px;font-size:11px;padding:3px 8px" placeholder="Search tasks‚Ä¶" oninput="renderAll()"/>
    </div>
    <div style="display:flex;gap:4px;background:var(--bg);border-radius:9px;padding:4px;">
      <button class="tab-btn active" onclick="switchTab('board')">üìä Board</button>
      <button class="tab-btn" onclick="switchTab('list')">üìã List</button>
    </div>
  </div>

  <div id="view-board"></div>
  <div id="view-list" class="hidden"></div>
</div>

<!-- TASK FORM MODAL -->
<div id="taskModal" class="modal-bg hidden">
  <div class="modal" style="max-width:700px">
    <div style="font-family:'Space Grotesk';font-weight:700;font-size:17px;color:var(--text);margin-bottom:16px" id="taskModalTitle">New Task</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:11px;margin-bottom:12px">
      <div><label style="font-size:11px;color:var(--dim);display:block;margin-bottom:4px">Title *</label>
        <input id="t_title" class="inp" placeholder="Task name"/></div>
      <div><label style="font-size:11px;color:var(--dim);display:block;margin-bottom:4px">Type</label>
        <select id="t_type" class="inp"><option value="TEST">Test</option><option value="BUG FIX">Bug Fix</option><option value="FEATURE">Feature</option><option value="DOCS">Docs</option></select></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:11px;margin-bottom:12px">
      <div><label style="font-size:11px;color:var(--dim);display:block;margin-bottom:4px">Priority</label>
        <select id="t_priority" class="inp"><option value="HIGH">HIGH</option><option value="MEDIUM" selected>MEDIUM</option><option value="LOW">LOW</option></select></div>
      <div><label style="font-size:11px;color:var(--dim);display:block;margin-bottom:4px">Environment</label>
        <input id="t_env" class="inp" placeholder="e.g. Staging"/></div>
      <div><label style="font-size:11px;color:var(--dim);display:block;margin-bottom:4px">Sprint</label>
        <input id="t_sprint" class="inp" placeholder="e.g. S24"/></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:11px;margin-bottom:12px">
      <div><label style="font-size:11px;color:var(--dim);display:block;margin-bottom:4px">Est. Hours</label>
        <input id="t_estimate" class="inp" type="number" placeholder="5"/></div>
      <div><label style="font-size:11px;color:var(--dim);display:block;margin-bottom:4px">Actual Hours</label>
        <input id="t_actual" class="inp" type="number" placeholder="0"/></div>
    </div>
    <div><label style="font-size:11px;color:var(--dim);display:block;margin-bottom:4px">Blocker</label>
      <input id="t_blocker" class="inp" placeholder="e.g. Waiting for API docs‚Ä¶"/></div>
    <div style="margin-bottom:12px"><label style="font-size:11px;color:var(--dim);display:block;margin-bottom:4px">Notes</label>
      <textarea id="t_notes" class="inp" rows="3" placeholder="Additional details‚Ä¶"></textarea></div>
    <div style="display:flex;gap:9px;justify-content:flex-end">
      <button class="btn" onclick="closeModal('taskModal')" style="background:#334155;color:#e2e8f0;padding:9px 18px">Cancel</button>
      <button class="btn" onclick="saveTask()" style="background:#1e40af;color:#fff;padding:9px 18px">Save Task</button>
    </div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ
const SHEET_URL = "https://script.google.com/macros/s/AKfycbywr9fKEN6Ow9TNPWvL1qpmcGFS0r8BQOxfWtrkTrZj6HlfRnHSmjcnzg9aYZGWntGljw/exec";

const STATUS = {
  TODO:{label:"To Do",color:"#6b7280",bg:"#f3f4f6"},
  IN_PROGRESS:{label:"In Progress",color:"#d97706",bg:"#fef3c7"},
  TESTING:{label:"Testing",color:"#7c3aed",bg:"#ede9fe"},
  BLOCKED:{label:"Blocked",color:"#dc2626",bg:"#fee2e2"},
  DONE:{label:"Done",color:"#059669",bg:"#d1fae5"},
};
const PRI = {HIGH:{c:"#dc2626"},MEDIUM:{c:"#d97706"},LOW:{c:"#059669"}};

let tasks=[],bugs=[],scrum={yesterday:"",today:"",blockers:"",mood:"üòä"};
let TM={}, globalInterval=null, autoSyncTimer=null, autoLoadInterval=null;
let activeTab="board", currentFilter="ALL", editingId=null;
let isLight=localStorage.getItem("qa_theme")==="light";
let isSyncing=false;
let serverTime=0; // Server time for timestamp sync

function load(k,def){try{return JSON.parse(localStorage.getItem(k)||"null")||def;}catch{return def;}}
function save(k,v){localStorage.setItem(k,JSON.stringify(v));}
function dk(){return new Date().toISOString().split("T")[0];}
function getToday(){return new Date().toLocaleDateString("en-IN",{weekday:"long",year:"numeric",month:"long",day:"numeric"});}
function esc(s){return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");}
function fmtT(sec){if(!sec||sec<0)return"0:00";const h=Math.floor(sec/3600),m=Math.floor((sec%3600)/60),s=sec%60;return h>0?`${h}h ${m}m`:`${m}:${String(s).padStart(2,"0")}`;}

function setCloud(state,msg){
  const dot=document.getElementById("cloudDot"),lbl=document.getElementById("cloudLabel");
  if(!dot||!lbl)return;
  dot.className="cloud-dot "+(state==="ok"?"cloud-ok":state==="err"?"cloud-err":"cloud-sync");
  lbl.textContent=msg;
}

function showSync(msg){
  const bar=document.getElementById("syncBar");
  if(!bar)return;
  bar.textContent=msg;
  bar.classList.remove("hidden");
}

// ‚îÄ‚îÄ TIMESTAMP-SAFE SAVE ‚îÄ‚îÄ
function saveTasks(){
  tasks.forEach(t=>{if(!t.lastModified)t.lastModified=Date.now();});
  save("qa_tasks",tasks);
  scheduleAutoSync();
}

function saveBugs(){
  bugs.forEach(b=>{if(!b.lastModified)b.lastModified=Date.now();});
  save("qa_bugs",bugs);
  scheduleAutoSync();
}

function scheduleAutoSync(){
  if(autoSyncTimer)clearTimeout(autoSyncTimer);
  autoSyncTimer=setTimeout(()=>syncSheet(false),3000);
}

// ‚îÄ‚îÄ FETCH WITH TIMEOUT ‚îÄ‚îÄ
function fetchFromSheet(){
  return new Promise((resolve,reject)=>{
    const cbName="QA_CB_"+Date.now();
    const script=document.createElement("script");
    const timeout=setTimeout(()=>{
      cleanup();reject(new Error("Sheet fetch timeout after 10s"));
    },10000);
    function cleanup(){
      clearTimeout(timeout);
      delete window[cbName];
      try{if(script.parentNode)script.parentNode.removeChild(script);}catch(e){}
    }
    window[cbName]=(data)=>{cleanup();resolve(data);};
    script.src=SHEET_URL+"?date="+dk()+"&t="+Date.now()+"&callback="+cbName;
    script.onerror=()=>{cleanup();reject(new Error("Failed to load from sheet"));};
    document.head.appendChild(script);
  });
}

// ‚îÄ‚îÄ SMART MERGE: Use timestamps to avoid conflicts ‚îÄ‚îÄ
function mergeFromSheet(sheetData){
  if(!sheetData)return;
  
  serverTime=sheetData.serverTime||Date.now();

  // TASKS: Merge by ID using timestamps
  if(Array.isArray(sheetData.tasks)&&sheetData.tasks.length>0){
    const merged={};
    tasks.forEach(t=>merged[String(t.id)]=t);
    
    sheetData.tasks.forEach(t=>{
      const key=String(t.id);
      const sheetTs=Number(t.lastModified)||serverTime;
      const localTs=merged[key]?.lastModified||0;
      
      if(!merged[key]||sheetTs>localTs){
        // Sheet version is newer
        merged[key]={...t,id:Number(t.id)||t.id,timerTotal:Number(t.timerTotal)||0,lastModified:sheetTs};
      }
      // Local version is newer, keep it
    });
    tasks=Object.values(merged);
  }

  // BUGS: Merge by ID using timestamps
  if(Array.isArray(sheetData.bugs)&&sheetData.bugs.length>0){
    const merged={};
    bugs.forEach(b=>merged[String(b.id)]=b);
    
    sheetData.bugs.forEach(b=>{
      const key=String(b.id);
      const sheetTs=Number(b.lastModified)||serverTime;
      const localTs=merged[key]?.lastModified||0;
      
      if(!merged[key]||sheetTs>localTs){
        merged[key]={...b,id:Number(b.id)||b.id,lastModified:sheetTs};
      }
    });
    bugs=Object.values(merged);
  }

  // SCRUM: Merge using timestamps
  if(sheetData.scrum){
    const sheetTs=Number(sheetData.scrum.lastModified)||serverTime;
    const localTs=scrum.lastModified||0;
    if(sheetTs>localTs){
      scrum={
        yesterday:sheetData.scrum.yesterday||scrum.yesterday,
        today:sheetData.scrum.today||scrum.today,
        blockers:sheetData.scrum.blockers||scrum.blockers,
        mood:sheetData.scrum.mood||scrum.mood,
        lastModified:sheetTs
      };
    }
  }

  // Sync timer state
  tasks.forEach(t=>{
    if(!TM[t.id])TM[t.id]={elapsed:t.timerTotal||0,state:"idle",startedAt:null};
  });

  save("qa_tasks",tasks);
  save("qa_bugs",bugs);
  save("qa_scrum_"+dk(),scrum);
}

// ‚îÄ‚îÄ PUSH: Send to sheet with timestamps ‚îÄ‚îÄ
async function pushToSheet(){
  await fetch(SHEET_URL,{
    method:"POST",
    body:JSON.stringify({
      tasks:tasks.map(t=>({...t,lastModified:t.lastModified||Date.now()})),
      bugs:bugs.map(b=>({...b,lastModified:b.lastModified||Date.now()})),
      scrum:{...scrum,lastModified:scrum.lastModified||Date.now()},
      date:dk(),
      name:localStorage.getItem("qa_name")||""
    }),
    mode:"no-cors"
  });
}

// ‚îÄ‚îÄ LOAD: Fetch and replace with sheet data ‚îÄ‚îÄ
async function loadFromSheet(){
  const btn=document.getElementById("loadBtn");
  if(btn){btn.textContent="‚è≥ Loading‚Ä¶";btn.disabled=true;}
  setCloud("sync","Loading from sheet‚Ä¶");
  try{
    const data=await fetchFromSheet();
    tasks=data.tasks?.map(t=>({...t,id:Number(t.id)||t.id,timerTotal:Number(t.timerTotal)||0,lastModified:t.lastModified||Date.now()}))|| [];
    bugs=data.bugs?.map(b=>({...b,id:Number(b.id)||b.id,lastModified:b.lastModified||Date.now()}))|| [];
    scrum=data.scrum||{yesterday:"",today:"",blockers:"",mood:"üòä",lastModified:Date.now()};
    serverTime=data.serverTime||Date.now();
    
    save("qa_tasks",tasks);
    save("qa_bugs",bugs);
    save("qa_scrum_"+dk(),scrum);
    tasks.forEach(t=>{if(!TM[t.id])TM[t.id]={elapsed:t.timerTotal||0,state:"idle",startedAt:null};});
    setCloud("ok","Fresh from sheet ‚úì");
    renderAll();
    showSync("‚úÖ Loaded fresh data from sheet!");
  }catch(err){
    console.error("Load error:",err);
    setCloud("err","Load failed, using cache");
    showSync("‚ö†Ô∏è Could not reach sheet: "+err.message);
    tasks=load("qa_tasks",[]);
    bugs=load("qa_bugs",[]);
    scrum=load("qa_scrum_"+dk(),{yesterday:"",today:"",blockers:"",mood:"üòä"});
    renderAll();
  }finally{
    if(btn){btn.textContent="‚¨áÔ∏è Load Fresh";btn.disabled=false;}
    setTimeout(()=>document.getElementById("syncBar").classList.add("hidden"),4000);
  }
}

// ‚îÄ‚îÄ SMART SYNC: Read ‚Üí Merge ‚Üí Push ‚îÄ‚îÄ
async function syncSheet(manual=true){
  if(isSyncing){console.log("Sync already in progress");return;}
  isSyncing=true;
  
  if(manual){
    const btn=document.getElementById("syncBtn");
    if(btn){btn.textContent="‚è≥ Syncing‚Ä¶";btn.disabled=true;}
  }
  setCloud("sync","Syncing with timestamps‚Ä¶");
  
  try{
    const sheetData=await fetchFromSheet();
    mergeFromSheet(sheetData);
    await pushToSheet();
    setCloud("ok","Synced ‚úì (conflict-free)");
    if(manual)showSync("‚úÖ Smart sync complete ‚Äî no data lost!");
    renderAll();
  }catch(err){
    console.error("Sync error:",err);
    setCloud("err","Sync failed");
    if(manual)showSync("‚ùå Sync failed: "+err.message);
  }finally{
    isSyncing=false;
    if(manual){
      const btn=document.getElementById("syncBtn");
      if(btn){btn.textContent="‚òÅÔ∏è Sync (Smart)";btn.disabled=false;}
      setTimeout(()=>document.getElementById("syncBar").classList.add("hidden"),4000);
    }
  }
}

// ‚îÄ‚îÄ AUTO-SYNC: Background every 90 seconds ‚îÄ‚îÄ
function startAutoLoad(){
  if(autoLoadInterval)clearInterval(autoLoadInterval);
  autoLoadInterval=setInterval(async()=>{
    if(!isSyncing){
      try{
        const data=await fetchFromSheet();
        mergeFromSheet(data);
        renderAll();
        setCloud("ok","Auto-synced ‚úì");
      }catch(e){console.log("Background sync failed (offline?)");}
    }
  },90000); // 90 seconds
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
(function init(){
  if(isLight){document.body.classList.add("light");document.getElementById("themeBtn").textContent="‚òÄÔ∏è Light";}
  document.getElementById("todayLabel").textContent=getToday();
  document.getElementById("myNameInput").value=localStorage.getItem("qa_name")||"";
  
  tasks=load("qa_tasks",[]);
  bugs=load("qa_bugs",[]);
  scrum=load("qa_scrum_"+dk(),{yesterday:"",today:"",blockers:"",mood:"üòä"});
  tasks.forEach(t=>{if(!TM[t.id])TM[t.id]={elapsed:t.timerTotal||0,state:"idle",startedAt:null};});
  
  startGlobalTick();
  renderAll();
  loadFromSheet(); // Load fresh on startup
  startAutoLoad(); // Background sync every 90s
})();

function startGlobalTick(){
  if(globalInterval)clearInterval(globalInterval);
  globalInterval=setInterval(()=>{
    Object.keys(TM).forEach(id=>{
      const tm=TM[id];if(tm.state!=="running")return;
      const total=tm.elapsed+Math.floor((Date.now()-tm.startedAt)/1000);
      const pill=document.getElementById("tpill_"+id);
      if(pill){pill.textContent="‚è± "+fmtT(total);}
    });
  },1000);
}

// ‚îÄ‚îÄ TIMER ‚îÄ‚îÄ
function timerStart(id){
  Object.keys(TM).forEach(oid=>{if(oid!=id&&TM[oid].state==="running")timerPause(oid);});
  if(!TM[id])TM[id]={elapsed:tasks.find(t=>t.id==id)?.timerTotal||0,state:"idle",startedAt:null};
  TM[id].state="running";TM[id].startedAt=Date.now();
}

function timerPause(id){
  if(!TM[id]||TM[id].state!=="running")return;
  TM[id].elapsed+=Math.floor((Date.now()-TM[id].startedAt)/1000);
  TM[id].state="paused";TM[id].startedAt=null;
  tasks=tasks.map(t=>t.id==id?{...t,timerTotal:TM[id].elapsed,lastModified:Date.now()}:t);
  saveTasks();
}

function timerReset(id){
  TM[id]={elapsed:0,state:"idle",startedAt:null};
  tasks=tasks.map(t=>t.id==id?{...t,timerTotal:0,lastModified:Date.now()}:t);
  saveTasks();
}

function getTimerElapsed(id){
  const tm=TM[id];if(!tm)return tasks.find(t=>t.id==id)?.timerTotal||0;
  if(tm.state==="running")return tm.elapsed+Math.floor((Date.now()-tm.startedAt)/1000);
  return tm.elapsed;
}

// ‚îÄ‚îÄ TASK CRUD ‚îÄ‚îÄ
function openTaskForm(id){
  document.getElementById("taskModal").classList.remove("hidden");
  if(id===null){
    document.getElementById("taskModalTitle").textContent="New Task";
    document.getElementById("t_title").value="";
    document.getElementById("t_type").value="TEST";
    document.getElementById("t_priority").value="MEDIUM";
    document.getElementById("t_env").value="";
    document.getElementById("t_sprint").value="";
    document.getElementById("t_estimate").value="";
    document.getElementById("t_actual").value="";
    document.getElementById("t_blocker").value="";
    document.getElementById("t_notes").value="";
    editingId=null;
  }else{
    const t=tasks.find(x=>x.id==id);
    if(!t)return;
    document.getElementById("taskModalTitle").textContent="Edit Task";
    document.getElementById("t_title").value=t.title;
    document.getElementById("t_type").value=t.type;
    document.getElementById("t_priority").value=t.priority;
    document.getElementById("t_env").value=t.env||"";
    document.getElementById("t_sprint").value=t.sprint||"";
    document.getElementById("t_estimate").value=t.estimate||"";
    document.getElementById("t_actual").value=t.actual||"";
    document.getElementById("t_blocker").value=t.blocker||"";
    document.getElementById("t_notes").value=t.notes||"";
    editingId=id;
  }
}

function saveTask(){
  const title=document.getElementById("t_title").value.trim();
  if(!title){alert("Title required!");return;}
  
  if(editingId===null){
    const newId=Math.max(...tasks.map(t=>Number(t.id)||0),0)+1;
    tasks.push({
      id:newId,title,type:document.getElementById("t_type").value,priority:document.getElementById("t_priority").value,status:"TODO",
      env:document.getElementById("t_env").value,estimate:document.getElementById("t_estimate").value,actual:document.getElementById("t_actual").value,
      sprint:document.getElementById("t_sprint").value,release:"",blocker:document.getElementById("t_blocker").value,
      notes:document.getElementById("t_notes").value,timerTotal:0,createdAt:new Date().toLocaleString(),lastModified:Date.now()
    });
  }else{
    tasks=tasks.map(t=>t.id==editingId?{...t,title,type:document.getElementById("t_type").value,priority:document.getElementById("t_priority").value,
      env:document.getElementById("t_env").value,estimate:document.getElementById("t_estimate").value,actual:document.getElementById("t_actual").value,
      sprint:document.getElementById("t_sprint").value,blocker:document.getElementById("t_blocker").value,notes:document.getElementById("t_notes").value,lastModified:Date.now()}:t);
  }
  saveTasks();
  closeModal("taskModal");
  renderAll();
}

function delTask(id){
  if(!confirm("Delete this task?"))return;
  tasks=tasks.filter(t=>t.id!=id);
  saveTasks();
  renderAll();
}

function updateStatus(id,status){
  tasks=tasks.map(t=>t.id==id?{...t,status,lastModified:Date.now()}:t);
  saveTasks();
  renderAll();
}

// ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ
function getStats(){
  return{
    total:tasks.length,
    done:tasks.filter(t=>t.status==="DONE").length,
    prog:tasks.filter(t=>t.status==="IN_PROGRESS"||t.status==="TESTING").length,
    blocked:tasks.filter(t=>t.blocker&&t.status!=="DONE").length,
    remaining:tasks.filter(t=>t.status!=="DONE").length,
    openBugs:bugs.filter(b=>b.status==="OPEN"||b.status==="REOPEN").length
  };
}

function renderStats(){
  const s=getStats(),pct=s.total?Math.round(s.done/s.total*100):0;
  document.getElementById("statsRow").innerHTML=[
    {l:"Total",v:s.total,icon:"üìù",c:"#3b82f6"},
    {l:"In Progress",v:s.prog,icon:"‚ö°",c:"#d97706"},
    {l:"Remaining",v:s.remaining,icon:"‚è≥",c:"#7c3aed"},
    {l:"Blocked",v:s.blocked,icon:"üöß",c:"#dc2626"},
    {l:"Done",v:s.done,icon:"‚úÖ",c:"#059669",pct},
    {l:"Open Bugs",v:s.openBugs,icon:"üêõ",c:"#f97316"},
  ].map(x=>`<div style="background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:13px 15px">
    <div style="font-size:17px;margin-bottom:4px">${x.icon}</div>
    <div style="font-size:22px;font-weight:700;color:${x.c};font-family:'Space Grotesk'">${x.v}</div>
    <div style="font-size:10px;color:var(--dim);margin-top:1px">${x.l}</div>
  </div>`).join("");
}

function getFiltered(){
  const q=(document.getElementById("searchInput")?.value||"").toLowerCase();
  return tasks.filter(t=>(t.title.toLowerCase().includes(q)||(t.notes||"").toLowerCase().includes(q)));
}

function cardHTML(t){
  const elapsed=getTimerElapsed(t.id);
  return`<div class="tcard" id="card_${t.id}">
    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px">
      <span style="font-size:12px;font-weight:600;color:var(--text);flex:1;line-height:1.4">${esc(t.title)}</span>
      <div style="display:flex;gap:3px;margin-left:5px;flex-shrink:0">
        <button class="btn" onclick="openTaskForm(${t.id})" style="background:#1e40af22;color:#60a5fa;padding:2px 6px;font-size:10px">‚úèÔ∏è</button>
        <button class="btn" onclick="delTask(${t.id})" style="background:#dc262622;color:#f87171;padding:2px 6px;font-size:10px">üóë</button>
      </div>
    </div>
    <div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:6px">
      <span class="badge" style="background:var(--border);color:var(--muted)">${t.type}</span>
      <span style="color:${PRI[t.priority]?.c||"#94a3b8"};font-size:10px;font-weight:700">${t.priority}</span>
      ${t.sprint?`<span class="badge" style="background:#1e40af22;color:#60a5fa">${esc(t.sprint)}</span>`:""}
      ${t.env?`<span class="badge" style="background:var(--surface);color:var(--dim)">${esc(t.env)}</span>`:""}
    </div>
    ${t.blocker?`<div style="background:#dc262611;border:1px solid #dc262633;border-radius:5px;padding:3px 7px;margin-bottom:5px;font-size:10px;color:#f87171">üöß ${esc(t.blocker)}</div>`:""}
    ${t.notes?`<div style="font-size:10px;color:var(--dim);margin-bottom:6px">${esc(t.notes.substring(0,50))}${t.notes.length>50?"‚Ä¶":""}</div>`:""}
    <div style="display:flex;gap:3px;margin-bottom:6px;flex-wrap:wrap">
      <span class="tpill tpill-idle" id="tpill_${t.id}">‚è± ${fmtT(elapsed)}</span>
      <button class="tbtn" onclick="timerStart(${t.id})" style="background:#05966922;color:#34d399">‚ñ∂</button>
      <button class="tbtn" onclick="timerPause(${t.id})" style="background:#d9770622;color:#d97706">‚è∏</button>
      <button class="tbtn" onclick="timerReset(${t.id})" style="background:#dc262622;color:#f87171">‚Ü∫</button>
    </div>
    <select onchange="updateStatus(${t.id},this.value)" style="width:100%;background:${STATUS[t.status]?.bg}33;color:${STATUS[t.status]?.color};border:1px solid ${STATUS[t.status]?.color}55;border-radius:6px;padding:5px 8px;font-size:11px;font-weight:700;cursor:pointer;font-family:inherit">
      ${Object.entries(STATUS).map(([k,v])=>`<option value="${k}" ${t.status===k?"selected":""}>${v.label}</option>`).join("")}
    </select>
  </div>`;
}

function renderBoard(){
  const f=getFiltered();
  document.getElementById("view-board").innerHTML=`<div style="display:grid;grid-template-columns:repeat(5,1fr);gap:10px">
    ${Object.entries(STATUS).map(([k,s])=>{
      const col=f.filter(t=>t.status===k);
      return`<div style="background:var(--surface);border-radius:11px;padding:12px;border:1px solid var(--border)">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
          <span style="font-weight:700;font-size:12px;color:${s.color}">${s.label}</span>
          <span style="background:${s.bg}33;color:${s.color};border-radius:20px;padding:1px 8px;font-size:11px;font-weight:700">${col.length}</span>
        </div>
        ${col.map(t=>cardHTML(t)).join("")}
        ${!col.length?`<div style="color:var(--border);font-size:11px;text-align:center;padding:14px 0">Empty</div>`:""}
      </div>`;
    }).join("")}
  </div>`;
}

function renderList(){
  const f=getFiltered();
  document.getElementById("view-list").innerHTML=`<div style="background:var(--surface);border-radius:11px;border:1px solid var(--border);overflow:auto">
    <table><thead><tr>${["Task","Type","Priority","Status","Sprint","Env","‚è±"].map(h=>`<th>${h}</th>`).join("")}</tr></thead>
    <tbody>${!f.length?`<tr><td colspan="7" style="padding:34px;text-align:center;color:var(--dim)">No tasks</td></tr>`:
      f.map(t=>`<tr>
        <td><button onclick="openTaskForm(${t.id})" style="border:none;background:none;cursor:pointer;color:#3b82f6;font-weight:500;text-align:left">${esc(t.title)}</button></td>
        <td style="font-size:11px;color:var(--dim)">${t.type}</td>
        <td><span style="color:${PRI[t.priority]?.c};font-weight:700">${t.priority}</span></td>
        <td><select onchange="updateStatus(${t.id},this.value)" style="background:${STATUS[t.status]?.bg}33;color:${STATUS[t.status]?.color};border:1px solid ${STATUS[t.status]?.color}55;border-radius:4px;padding:3px 6px;font-size:11px;font-weight:700;font-family:inherit">${Object.entries(STATUS).map(([k,v])=>`<option value="${k}" ${t.status===k?"selected":""}>${v.label}</option>`).join("")}</select></td>
        <td style="font-size:11px;color:var(--dim)">${t.sprint||"‚Äî"}</td>
        <td style="font-size:11px;color:var(--dim)">${t.env||"‚Äî"}</td>
        <td><span class="tpill tpill-idle" id="tpill_${t.id}">‚è± ${fmtT(getTimerElapsed(t.id))}</span></td>
      </tr>`).join("")}</tbody></table></div>`;
}

function renderAll(){
  renderStats();
  if(activeTab==="board")renderBoard();else renderList();
}

function switchTab(tab){
  activeTab=tab;
  document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
  event.target.classList.add("active");
  document.getElementById("view-board").classList.add("hidden");
  document.getElementById("view-list").classList.add("hidden");
  if(tab==="board"){document.getElementById("view-board").classList.remove("hidden");renderBoard();}
  else{document.getElementById("view-list").classList.remove("hidden");renderList();}
}

function toggleTheme(){
  isLight=!isLight;
  localStorage.setItem("qa_theme",isLight?"light":"dark");
  document.body.classList.toggle("light");
  document.getElementById("themeBtn").textContent=isLight?"‚òÄÔ∏è Light":"üåô Dark";
}

function closeModal(id){
  document.getElementById(id).classList.add("hidden");
}
</script>
</body>
</html>
