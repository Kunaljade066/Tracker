<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>QA Tracker</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Space+Grotesk:wght@500;700&display=swap');
*{box-sizing:border-box;margin:0;padding:0}
:root{--bg:#0f172a;--surface:#1e293b;--surface2:#162032;--border:#334155;--text:#e2e8f0;--muted:#94a3b8;--dim:#64748b}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;transition:background .25s,color .25s}
body.light{--bg:#f1f5f9;--surface:#ffffff;--surface2:#f8fafc;--border:#e2e8f0;--text:#1e293b;--muted:#475569;--dim:#94a3b8}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:var(--surface)}::-webkit-scrollbar-thumb{background:#475569;border-radius:3px}
input,select,textarea{font-family:inherit;outline:none}
.inp{background:var(--surface2);border:1.5px solid var(--border);border-radius:8px;padding:9px 13px;color:var(--text);font-size:14px;width:100%;transition:border-color .2s}
.inp:focus{border-color:#3b82f6}
.btn{cursor:pointer;border:none;border-radius:8px;font-family:inherit;font-weight:600;transition:all .15s;display:inline-flex;align-items:center;gap:5px;white-space:nowrap}
.btn:hover{filter:brightness(1.1);transform:translateY(-1px)}
.btn:active{transform:translateY(0)}
.hidden{display:none!important}
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.82);z-index:300;display:flex;align-items:center;justify-content:center;padding:16px}
.modal{background:var(--surface);border-radius:16px;padding:26px;max-width:660px;width:100%;max-height:93vh;overflow-y:auto;border:1px solid var(--border);box-shadow:0 24px 64px rgba(0,0,0,.5)}
.eod-modal{background:var(--surface);border-radius:16px;max-width:820px;width:100%;max-height:95vh;overflow-y:auto;border:1px solid #f59e0b55;box-shadow:0 0 80px rgba(245,158,11,.18)}
.pb{height:5px;border-radius:3px;background:var(--border);overflow:hidden}
.pb-fill{height:100%;border-radius:3px;transition:width .5s ease}
.tcard{background:var(--surface2);border-radius:10px;padding:11px;border:1px solid var(--border);transition:all .18s;margin-bottom:8px}
.tcard:hover{box-shadow:0 4px 18px rgba(0,0,0,.35);border-color:#475569}
table{width:100%;border-collapse:collapse}
th{padding:10px 13px;text-align:left;font-size:11px;color:var(--dim);font-weight:700;border-bottom:1px solid var(--border);background:var(--bg);letter-spacing:.5px;text-transform:uppercase}
td{padding:9px 13px;border-bottom:1px solid var(--border);font-size:13px;vertical-align:middle}
.tpill{font-family:'Space Grotesk';font-size:12px;font-weight:700;padding:3px 9px;border-radius:20px;display:inline-flex;align-items:center;gap:4px}
.tpill-idle{color:#64748b;background:#64748b18;border:1px solid #64748b33}
.tpill-run{color:#059669;background:#05966918;border:1px solid #05966944;animation:pulse-green 2s infinite}
.tpill-pause{color:#d97706;background:#d9770618;border:1px solid #d9770644}
@keyframes pulse-green{0%,100%{box-shadow:0 0 0 0 #05966933}50%{box-shadow:0 0 0 4px #05966900}}
.tbtn{cursor:pointer;border:none;border-radius:6px;font-size:10px;font-weight:700;padding:2px 7px;font-family:inherit;transition:all .12s}
.tbtn:hover{filter:brightness(1.15)}
.tab-btn{cursor:pointer;padding:7px 14px;border-radius:7px;font-weight:500;font-size:13px;transition:all .18s;border:none;background:transparent;color:var(--muted);font-family:inherit}
.tab-btn.active{background:#1e40af;color:#fff}
.tab-btn:hover:not(.active){background:var(--surface);color:var(--text)}
.mood-btn{font-size:22px;background:transparent;border:2px solid var(--border);border-radius:10px;padding:6px 12px;cursor:pointer;transition:all .18s}
.mood-btn.active{background:#1e40af33;border-color:#3b82f6}
@keyframes glow{0%,100%{box-shadow:0 0 8px #f59e0b55}50%{box-shadow:0 0 22px #f59e0baa}}
.eod-glow{animation:glow 2.5s infinite}
.rpt-pre{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:16px;font-family:'Courier New',monospace;font-size:11.5px;line-height:1.9;white-space:pre-wrap;word-break:break-word;max-height:360px;overflow-y:auto;color:var(--muted)}
.sev-CRITICAL{color:#dc2626;font-weight:700}.sev-HIGH{color:#f97316;font-weight:700}.sev-MEDIUM{color:#d97706;font-weight:700}.sev-LOW{color:#059669;font-weight:700}.sev-URGENT{color:#dc2626;font-weight:700}
.wday{background:var(--surface);border-radius:10px;padding:12px;border:1px solid var(--border);min-height:90px}
.wday.today-col{border-color:#3b82f6;box-shadow:0 0 0 1px #3b82f655}
.scratchpad{background:var(--surface2);border:1.5px solid var(--border);border-radius:10px;padding:14px;font-family:'DM Sans',sans-serif;font-size:14px;color:var(--text);resize:vertical;min-height:160px;width:100%;line-height:1.75}
.rtab{cursor:pointer;padding:7px 18px;border-radius:7px;font-size:13px;font-weight:600;border:none;font-family:inherit;transition:all .15s}
.badge{display:inline-block;padding:1px 7px;border-radius:4px;font-size:10px;font-weight:500}
.cloud-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:4px}
.cloud-ok{background:#059669}.cloud-err{background:#dc2626}
.cloud-sync{background:#d97706;animation:blink .8s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}

/* Auto-sync pulse indicator */
.sync-pulse{width:8px;height:8px;border-radius:50%;background:#3b82f6;animation:sync-ring 1.5s infinite}
@keyframes sync-ring{0%{box-shadow:0 0 0 0 #3b82f666}70%{box-shadow:0 0 0 6px #3b82f600}100%{box-shadow:0 0 0 0 #3b82f600}}

.import-area{background:var(--surface2);border:2px dashed var(--border);border-radius:12px;padding:16px;font-size:13px;color:var(--dim);resize:vertical;min-height:120px;width:100%;line-height:1.6;transition:border-color .2s}
.import-area:focus{border-color:#3b82f6;color:var(--text)}
.bug-import-row{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:8px 12px;margin-bottom:6px;display:flex;align-items:center;gap:10px;font-size:12px}

/* ========= MOBILE NAV HAMBURGER ========= */
.mob-menu{display:none;flex-direction:column;gap:4px;cursor:pointer;padding:8px;border-radius:8px;background:var(--surface);border:1px solid var(--border)}
.mob-menu span{width:20px;height:2px;background:var(--text);border-radius:2px;transition:all .2s}
#mobileNav{display:none;position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.85);padding:16px}
#mobileNavPanel{background:var(--surface);border-radius:16px;padding:20px;display:flex;flex-direction:column;gap:10px;max-height:90vh;overflow-y:auto}
#mobileNavPanel .mob-btn{width:100%;padding:13px 16px;border-radius:10px;font-size:14px;font-weight:600;border:none;cursor:pointer;font-family:inherit;text-align:left;display:flex;align-items:center;gap:10px}

/* ========= RESPONSIVE BREAKPOINTS ========= */
@media(max-width:768px){
  /* Header */
  .hdr-inner{height:auto!important;padding:10px 0!important;flex-wrap:nowrap!important;align-items:center!important}
  .hdr-btns{display:none!important}
  .mob-menu{display:flex!important}
  #todayLabel{display:none!important}

  /* Stats grid: 2 cols on mobile */
  #statsRow{grid-template-columns:repeat(3,1fr)!important;gap:7px!important}

  /* Control strip: stack nicely */
  .ctrl-strip{flex-direction:column!important;align-items:stretch!important}
  .ctrl-strip > div{width:100%!important}
  .ctrl-strip input{width:100%!important}

  /* Tab bar: scrollable horizontal */
  .tab-bar{overflow-x:auto!important;flex-wrap:nowrap!important;-webkit-overflow-scrolling:touch;scrollbar-width:none}
  .tab-bar::-webkit-scrollbar{display:none}
  .tab-btn{padding:7px 12px!important;font-size:12px!important;white-space:nowrap!important}

  /* Search + filter: stack */
  .search-filter{flex-direction:column!important;width:100%!important}
  .search-filter input,.search-filter select{width:100%!important}

  /* Board: single column on mobile */
  .board-grid{grid-template-columns:1fr!important}

  /* Weekly: 3+4 split or scroll */
  .weekly-grid{grid-template-columns:repeat(3,1fr)!important;font-size:11px!important}

  /* Charts: single column */
  .charts-grid{grid-template-columns:1fr!important}
  .report-grid{grid-template-columns:1fr!important}

  /* Table: make it scrollable */
  .table-wrap{overflow-x:auto!important;-webkit-overflow-scrolling:touch}

  /* Task form grids: stack */
  .form-grid-3{grid-template-columns:1fr!important}
  .form-grid-2{grid-template-columns:1fr!important}
  .form-grid-4{grid-template-columns:1fr 1fr!important}

  /* EOD modal grid */
  .eod-name-grid{grid-template-columns:1fr!important}

  /* Modal padding */
  .modal{padding:16px!important;border-radius:12px!important}

  /* Bottom EOD banner */
  .eod-banner{flex-direction:column!important;text-align:center!important}
  .eod-banner button{width:100%!important;justify-content:center!important}

  /* Bug form grid */
  .bug-form-grid{grid-template-columns:1fr!important}

  /* Import tab grid */
  .import-url-grid{grid-template-columns:1fr!important}

  /* Active timer badge */
  #activeTimerBadge{width:100%!important}
}

@media(max-width:480px){
  #statsRow{grid-template-columns:repeat(2,1fr)!important}
  .weekly-grid{grid-template-columns:repeat(2,1fr)!important}
  .form-grid-4{grid-template-columns:1fr!important}
  .tab-btn{padding:6px 10px!important;font-size:11px!important}
}

/* Additional mobile-specific overrides */
@media(max-width:768px){
  .hdr-btns{display:none!important}
  .mob-menu{display:flex!important}
  .ctrl-strip{display:none!important}
  .stats-grid{grid-template-columns:repeat(3,1fr)!important;gap:7px!important}
  .tab-bar{flex-wrap:nowrap!important;overflow-x:auto!important;scrollbar-width:none!important;padding-bottom:2px}
  .tab-bar::-webkit-scrollbar{display:none}
  .tab-btn{white-space:nowrap!important;padding:6px 10px!important;font-size:11px!important}
  .board-grid{grid-template-columns:1fr!important}
  .weekly-grid{grid-template-columns:repeat(3,1fr)!important}
  .charts-grid{grid-template-columns:1fr!important}
  .report-grid{grid-template-columns:1fr!important}
  .form-grid-3{grid-template-columns:1fr!important}
  .form-grid-2{grid-template-columns:1fr!important}
  .form-grid-4{grid-template-columns:1fr 1fr!important}
  .bug-form-grid{grid-template-columns:1fr!important}
  .eod-name-grid{grid-template-columns:1fr!important}
  .import-url-grid{grid-template-columns:1fr!important}
  .eod-banner{flex-direction:column!important;text-align:center!important}
  .eod-banner button{width:100%!important;justify-content:center!important}
  .search-filter{max-width:100%!important;flex:none!important;width:100%}
  .search-filter select{width:110px!important}
  .modal{padding:16px!important;border-radius:12px!important}
  .modal-bg{padding:10px!important;align-items:flex-end!important}
  .eod-modal{border-radius:12px 12px 0 0!important}
  #todayLabel{display:none!important}
}
@media(max-width:480px){
  .stats-grid{grid-template-columns:repeat(2,1fr)!important}
  .weekly-grid{grid-template-columns:repeat(2,1fr)!important}
  .form-grid-4{grid-template-columns:1fr!important}
  .modal-bg{padding:0!important;align-items:flex-end!important}
  .modal{border-radius:16px 16px 0 0!important;max-height:96vh!important}
}
</style>
</head>
<body>

<!-- MOBILE NAV OVERLAY -->
<div id="mobileNav" style="display:none;position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.85);padding:16px" onclick="if(event.target===this)closeMobNav()">
  <div style="background:var(--surface);border-radius:16px;padding:20px;display:flex;flex-direction:column;gap:10px;max-height:90vh;overflow-y:auto">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px">
      <div style="font-family:'Space Grotesk';font-weight:700;font-size:15px;color:var(--text)">ğŸ§ª QA Tracker</div>
      <button onclick="closeMobNav()" style="background:var(--border);border:none;color:var(--text);border-radius:8px;padding:6px 12px;font-size:13px;cursor:pointer">âœ•</button>
    </div>
    <input id="myNameInputMob" class="inp" style="font-size:13px;padding:8px 12px" placeholder="Your nameâ€¦" oninput="onNameChange(this.value);document.getElementById('myNameInput').value=this.value"/>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
      <button onclick="openTaskForm(null);closeMobNav()" style="background:#1e40af;color:#fff;border:none;border-radius:10px;padding:13px 10px;font-size:13px;font-weight:700;cursor:pointer;font-family:inherit">â• New Task</button>
      <button onclick="openEOD();closeMobNav()" class="eod-glow" style="background:linear-gradient(135deg,#f59e0b,#ef4444);color:#fff;border:none;border-radius:10px;padding:13px 10px;font-size:13px;font-weight:700;cursor:pointer;font-family:inherit">ğŸ“¤ EOD</button>
    </div>
    <button onclick="openScrum();closeMobNav()" style="background:#7c3aed22;color:#a78bfa;border:1px solid #7c3aed44;border-radius:10px;padding:12px 16px;font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;text-align:left">ğŸ“‹ Daily Scrum Notes</button>
    <button onclick="openBugModal();closeMobNav()" style="background:#dc262622;color:#f87171;border:1px solid #dc262644;border-radius:10px;padding:12px 16px;font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;text-align:left">ğŸ› Log Bug</button>
    <button onclick="openImportBugs();closeMobNav()" style="background:#b4530922;color:#fbbf24;border:1px solid #b4530944;border-radius:10px;padding:12px 16px;font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;text-align:left">ğŸ“¥ Import Bugs</button>
    <button onclick="openScratch();closeMobNav()" style="background:#0369a122;color:#38bdf8;border:1px solid #0369a144;border-radius:10px;padding:12px 16px;font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;text-align:left">ğŸ“ Quick Notes</button>
    <div style="border-top:1px solid var(--border);padding-top:10px">
      <div style="font-size:11px;color:var(--dim);margin-bottom:8px;font-weight:700;text-transform:uppercase;letter-spacing:.5px">Settings</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px">
        <div style="background:var(--surface2);border:1px solid var(--border);border-radius:9px;padding:8px 10px">
          <div style="font-size:10px;color:var(--dim);margin-bottom:4px">ğŸ·ï¸ Sprint</div>
          <input id="sprintInputMob" class="inp" style="font-size:12px;padding:4px 8px" placeholder="Sprint 24" oninput="onSprintChange(this.value);document.getElementById('sprintInput').value=this.value"/>
        </div>
        <div style="background:var(--surface2);border:1px solid var(--border);border-radius:9px;padding:8px 10px">
          <div style="font-size:10px;color:var(--dim);margin-bottom:4px">ğŸš€ Release</div>
          <input id="releaseInputMob" class="inp" style="font-size:12px;padding:4px 8px" placeholder="v2.4.1" oninput="onReleaseChange(this.value);document.getElementById('releaseInput').value=this.value"/>
        </div>
      </div>
      <div style="background:var(--surface2);border:1px solid var(--border);border-radius:9px;padding:8px 10px;margin-bottom:8px">
        <div style="font-size:10px;color:var(--dim);margin-bottom:4px">â° EOD Reminder Time</div>
        <input id="reminderTimeMob" type="time" class="inp" style="font-size:12px;padding:4px 8px;width:100%" value="18:00" onchange="document.getElementById('reminderTime').value=this.value;scheduleReminder()"/>
      </div>
      <button onclick="toggleTheme()" id="themeBtnMob" style="width:100%;background:var(--surface);color:var(--text);border:1px solid var(--border);border-radius:9px;padding:10px;font-size:13px;cursor:pointer;font-family:inherit;font-weight:600">ğŸŒ™ Toggle Theme</button>
    </div>
    <div style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--surface2);border-radius:8px;border:1px solid var(--border)">
      <span id="cloudDotMob" class="cloud-dot cloud-ok"></span>
      <span id="cloudLabelMob" style="font-size:11px;color:var(--dim)">Connectingâ€¦</span>
      <span id="liveIndicatorMob" style="font-size:10px;color:#3b82f6;font-weight:700;display:none;margin-left:4px">â— LIVE</span>
      <span id="lastSyncInfoMob" style="font-size:10px;color:var(--dim);margin-left:auto"></span>
    </div>
  </div>
</div>

<!-- HEADER -->
<div style="background:var(--bg);border-bottom:1px solid var(--border);padding:0 18px;position:sticky;top:0;z-index:100">
  <div class="hdr-inner" style="max-width:1340px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;height:58px;gap:8px">
    <div style="display:flex;align-items:center;gap:10px;flex-shrink:0;min-width:0;overflow:hidden">
      <div style="background:linear-gradient(135deg,#3b82f6,#06b6d4);border-radius:10px;width:36px;height:36px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:18px">ğŸ§ª</div>
      <div style="min-width:0">
        <div style="font-family:'Space Grotesk';font-weight:700;font-size:15px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">QA Tracker â€” Kunal Jade</div>
        <div style="display:flex;align-items:center;gap:6px">
          <div id="todayLabel" style="font-size:11px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:200px"></div>
          <span style="font-size:11px;color:var(--dim);display:flex;align-items:center;gap:4px;flex-shrink:0">
            <span id="cloudDot" class="cloud-dot cloud-ok"></span><span id="cloudLabel">Connectingâ€¦</span>
            <span id="liveIndicator" style="font-size:10px;color:#3b82f6;font-weight:700;display:none">â— LIVE</span>
          </span>
        </div>
      </div>
    </div>
    <!-- Desktop buttons -->
    <div class="hdr-btns" style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">
      <input id="myNameInput" class="inp" style="width:115px;font-size:12px;padding:5px 9px" placeholder="Your nameâ€¦" oninput="onNameChange(this.value)"/>
      <button class="btn" onclick="openScrum()" style="background:#7c3aed;color:#fff;padding:7px 11px;font-size:12px">ğŸ“‹ Scrum</button>
      <button class="btn" onclick="openBugModal()" style="background:#dc2626;color:#fff;padding:7px 11px;font-size:12px">ğŸ› Bugs</button>
      <button class="btn" onclick="openImportBugs()" style="background:#b45309;color:#fff;padding:7px 11px;font-size:12px">ğŸ“¥ Import</button>
      <button class="btn" onclick="openScratch()" style="background:#0369a1;color:#fff;padding:7px 11px;font-size:12px">ğŸ“ Notes</button>
      <button class="btn" id="themeBtn" onclick="toggleTheme()" style="background:var(--surface);color:var(--text);padding:7px 11px;font-size:12px;border:1px solid var(--border)">ğŸŒ™ Dark</button>
      <button class="btn" onclick="openTaskForm(null)" style="background:#1e40af;color:#fff;padding:7px 12px;font-size:12px">+ Task</button>
      <button class="btn eod-glow" onclick="openEOD()" style="background:linear-gradient(135deg,#f59e0b,#ef4444);color:#fff;padding:8px 15px;font-size:13px;border-radius:10px;font-weight:700">ğŸ“¤ EOD</button>
    </div>
    <!-- Mobile hamburger -->
    <div class="mob-menu" onclick="openMobNav()">
      <span></span><span></span><span></span>
    </div>
  </div>
</div>

<div id="syncBar" class="hidden" style="background:var(--surface);padding:6px 20px;text-align:center;font-size:13px;color:var(--muted);border-bottom:1px solid var(--border)"></div>
<div id="reminderBar" class="hidden" onclick="openEOD();this.classList.add('hidden')" style="background:linear-gradient(90deg,#f59e0b,#ef4444);padding:10px 20px;text-align:center;font-size:13px;color:#fff;font-weight:700;cursor:pointer">â° EOD Reminder â€” Tap to generate your daily report!</div>

<div style="max-width:1340px;margin:0 auto;padding:14px 14px 30px">
  <div id="statsRow" class="stats-grid" style="display:grid;grid-template-columns:repeat(6,1fr);gap:8px;margin-bottom:12px"></div>

  <div class="ctrl-strip" style="display:flex;align-items:center;gap:8px;margin-bottom:12px;flex-wrap:wrap">
    <div style="display:flex;align-items:center;gap:6px;background:var(--surface);border:1px solid var(--border);border-radius:9px;padding:5px 12px">
      <span style="font-size:11px;color:var(--dim)">ğŸ·ï¸ Sprint</span>
      <input id="sprintInput" class="inp" style="width:110px;font-size:11px;padding:3px 8px" placeholder="Sprint 24" oninput="onSprintChange(this.value)"/>
    </div>
    <div style="display:flex;align-items:center;gap:6px;background:var(--surface);border:1px solid var(--border);border-radius:9px;padding:5px 12px">
      <span style="font-size:11px;color:var(--dim)">ğŸš€ Release</span>
      <input id="releaseInput" class="inp" style="width:90px;font-size:11px;padding:3px 8px" placeholder="v2.4.1" oninput="onReleaseChange(this.value)"/>
    </div>
    <div style="display:flex;align-items:center;gap:6px;background:var(--surface);border:1px solid var(--border);border-radius:9px;padding:5px 12px">
      <span style="font-size:11px;color:var(--dim)">â° EOD at</span>
      <input id="reminderTime" type="time" class="inp" style="width:90px;font-size:11px;padding:3px 8px" value="18:00" onchange="scheduleReminder()"/>
    </div>
    <div style="display:flex;align-items:center;gap:6px;background:var(--surface);border:1px solid var(--border);border-radius:9px;padding:5px 12px">
      <span id="autoSyncDot" class="cloud-dot cloud-ok"></span>
      <span id="autoSyncLabel" style="font-size:11px;color:var(--dim)">Auto-sync: ON</span>
    </div>
    <div id="activeTimerBadge" class="hidden" style="display:flex;align-items:center;gap:6px;background:#05966918;border:1px solid #05966944;border-radius:9px;padding:5px 14px">
      <span style="font-size:11px;color:#059669;font-weight:700">â± Active:</span>
      <span id="activeTimerLabel" style="font-size:11px;color:#059669;font-family:'Space Grotesk';font-weight:700"></span>
    </div>
    <div id="lastSyncInfo" style="font-size:11px;color:var(--dim);padding:5px 12px;background:var(--surface);border:1px solid var(--border);border-radius:9px"></div>
  </div>

  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:8px">
    <div class="tab-bar" style="display:flex;gap:3px;background:var(--surface);border-radius:10px;padding:3px;overflow-x:auto;-webkit-overflow-scrolling:touch">
      <button class="tab-btn active" id="tab-board"  onclick="switchTab('board')">ğŸ—‚ Board</button>
      <button class="tab-btn" id="tab-list"   onclick="switchTab('list')">ğŸ“‹ List</button>
      <button class="tab-btn" id="tab-weekly" onclick="switchTab('weekly')">ğŸ“… Weekly</button>
      <button class="tab-btn" id="tab-bugs"   onclick="switchTab('bugs')">ğŸ› Bugs</button>
      <button class="tab-btn" id="tab-charts" onclick="switchTab('charts')">ğŸ“Š Charts</button>
      <button class="tab-btn" id="tab-report" onclick="switchTab('report')">ğŸ“ˆ Report</button>
    </div>
    <div class="search-filter" style="display:flex;gap:6px;align-items:center;flex:1;min-width:0;max-width:320px">
      <input class="inp" id="searchInput" style="font-size:12px;padding:6px 10px;min-width:0;flex:1" placeholder="ğŸ” Searchâ€¦" oninput="renderCurrent()"/>
      <select class="inp" id="filterSel" style="width:120px;font-size:12px;padding:6px 9px;flex-shrink:0" onchange="currentFilter=this.value;renderCurrent()">
        <option value="ALL">All Status</option><option value="TODO">To Do</option><option value="IN_PROGRESS">In Progress</option>
        <option value="TESTING">Testing</option><option value="BLOCKED">Blocked</option><option value="DONE">Done</option>
      </select>
    </div>
  </div>

  <div id="view-board"></div>
  <div id="view-list" class="hidden"></div>
  <div id="view-weekly" class="hidden"></div>
  <div id="view-bugs" class="hidden"></div>
  <div id="view-charts" class="hidden"></div>
  <div id="view-report" class="hidden"></div>

  <div class="eod-banner" style="margin-top:20px;background:linear-gradient(135deg,#1c1917,#1e1b4b);border:1px solid #f59e0b44;border-radius:13px;padding:16px 22px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px">
    <div>
      <div style="font-family:'Space Grotesk';font-weight:700;font-size:16px;color:#fbbf24">ğŸ“¤ Ready to wrap up?</div>
      <div style="font-size:12px;color:#94a3b8;margin-top:3px">Generate EOD report â†’ Copy â†’ Paste in Gmail/WhatsApp â†’ Done!</div>
    </div>
    <button class="btn eod-glow" onclick="openEOD()" style="background:linear-gradient(135deg,#f59e0b,#ef4444);color:#fff;padding:11px 24px;font-size:14px;border-radius:11px;font-weight:700">ğŸ“¤ Generate EOD Report</button>
  </div>
</div>

<!-- TASK MODAL -->
<div id="taskModal" class="modal-bg hidden">
  <div class="modal">
    <div id="taskModalTitle" style="font-family:'Space Grotesk';font-weight:700;font-size:17px;color:var(--text);margin-bottom:16px">â• New Task</div>
    <div style="display:flex;flex-direction:column;gap:12px">
      <div><label style="font-size:11px;color:var(--dim);display:block;margin-bottom:4px">Task Title *</label>
        <input id="f_title" class="inp" placeholder="e.g. Test login flow on Chrome"/></div>
      <div class="form-grid-3" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:9px">
        <div><label style="font-size:11px;color:var(--dim);display:block;margin-bottom:4px">Type</label>
          <select id="f_type" class="inp"><option>Bug</option><option>Test Case</option><option>Regression</option><option>Smoke</option><option>UAT</option><option>Automation</option><option>Review</option><option>Other</option></select></div>
        <div><label style="font-size:11px;color:var(--dim);display:block;margin-bottom:4px">Priority</label>
          <select id="f_priority" class="inp"><option value="HIGH">ğŸ”´ High</option><option value="MEDIUM" selected>ğŸŸ¡ Medium</option><option value="LOW">ğŸŸ¢ Low</option></select></div>
        <div><label style="font-size:11px;color:var(--dim);display:block;margin-bottom:4px">Status</label>
          <select id="f_status" class="inp"><option value="TODO">To Do</option><option value="IN_PROGRESS">In Progress</option><option value="TESTING">Testing</option><option value="BLOCKED">Blocked</option><option value="DONE">Done</option></select></div>
      </div>
      <div class="form-grid-2" style="display:grid;grid-template-columns:1fr 1fr;gap:9px">
        <div><label style="font-size:11px;color:var(--dim);display:block;margin-bottom:4px">Environment</label>
          <input id="f_env" class="inp" placeholder="Staging / QA / Prod"/></div>
        <div><label style="font-size:11px;color:var(--dim);display:block;margin-bottom:4px">Assignee</label>
          <input id="f_assignee" class="inp" placeholder="Self / Dev Team"/></div>
      </div>
      <div class="form-grid-4" style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:9px">
        <div><label style="font-size:11px;color:var(--dim);display:block;margin-bottom:4px">Estimate</label><input id="f_est" class="inp" placeholder="2h"/></div>
        <div><label style="font-size:11px;color:var(--dim);display:block;margin-bottom:4px">Actual</label><input id="f_actual" class="inp" placeholder="1.5h"/></div>
        <div><label style="font-size:11px;color:var(--dim);display:block;margin-bottom:4px">Sprint</label><input id="f_sprint" class="inp" placeholder="Sprint 24"/></div>
        <div><label style="font-size:11px;color:var(--dim);display:block;margin-bottom:4px">Release</label><input id="f_release" class="inp" placeholder="v2.4.1"/></div>
      </div>
      <div><label style="font-size:11px;color:var(--dim);display:block;margin-bottom:4px">ğŸš§ Blocker</label>
        <input id="f_blocker" class="inp" placeholder="e.g. Waiting for dev fix JIRA-123"/></div>
      <div><label style="font-size:11px;color:var(--dim);display:block;margin-bottom:4px">Notes</label>
        <textarea id="f_notes" class="inp" rows="2" placeholder="Steps, links, observationsâ€¦"></textarea></div>
      <div style="display:flex;gap:9px;justify-content:flex-end">
        <button class="btn" onclick="closeModal('taskModal')" style="background:#334155;color:#e2e8f0;padding:9px 18px">Cancel</button>
        <button class="btn" onclick="saveTask()" id="saveTaskBtn" style="background:#1e40af;color:#fff;padding:9px 18px">Add Task</button>
      </div>
    </div>
  </div>
</div>

<!-- SCRUM MODAL -->
<div id="scrumModal" class="modal-bg hidden">
  <div class="modal">
    <div style="font-family:'Space Grotesk';font-weight:700;font-size:17px;color:var(--text);margin-bottom:3px">ğŸ“‹ Daily Scrum Notes</div>
    <div id="scrumDate" style="font-size:11px;color:var(--dim);margin-bottom:16px"></div>
    <div style="display:flex;flex-direction:column;gap:13px">
      <div><label style="font-size:11px;color:#059669;font-weight:700;display:block;margin-bottom:5px">âœ… What did you do YESTERDAY?</label>
        <textarea id="s_yesterday" class="inp" rows="3" placeholder="e.g. Completed regression testingâ€¦"></textarea></div>
      <div><label style="font-size:11px;color:#3b82f6;font-weight:700;display:block;margin-bottom:5px">ğŸš€ What will you do TODAY?</label>
        <textarea id="s_today" class="inp" rows="3" placeholder="e.g. Test payment gatewayâ€¦"></textarea></div>
      <div><label style="font-size:11px;color:#dc2626;font-weight:700;display:block;margin-bottom:5px">ğŸš§ Any BLOCKERS?</label>
        <textarea id="s_blockers" class="inp" rows="2" placeholder="e.g. API not readyâ€¦"></textarea></div>
      <div><label style="font-size:11px;color:var(--dim);font-weight:700;display:block;margin-bottom:7px">ğŸ˜Š How's your day?</label>
        <div id="moodRow" style="display:flex;gap:8px">
          <button class="mood-btn" onclick="setMood('ğŸ˜«')">ğŸ˜«</button>
          <button class="mood-btn" onclick="setMood('ğŸ˜•')">ğŸ˜•</button>
          <button class="mood-btn" onclick="setMood('ğŸ˜')">ğŸ˜</button>
          <button class="mood-btn active" onclick="setMood('ğŸ˜Š')">ğŸ˜Š</button>
          <button class="mood-btn" onclick="setMood('ğŸš€')">ğŸš€</button>
        </div>
      </div>
      <div style="display:flex;gap:9px;justify-content:flex-end">
        <button class="btn" onclick="closeModal('scrumModal')" style="background:#334155;color:#e2e8f0;padding:9px 18px">Cancel</button>
        <button class="btn" onclick="saveScrumData()" style="background:#7c3aed;color:#fff;padding:9px 18px">Save Notes</button>
      </div>
    </div>
  </div>
</div>

<!-- BUG MODAL -->
<div id="bugModal" class="modal-bg hidden">
  <div class="modal" style="max-width:720px">
    <div style="font-family:'Space Grotesk';font-weight:700;font-size:17px;color:var(--text);margin-bottom:16px">ğŸ› Bug Log</div>
    <div style="display:flex;flex-direction:column;gap:10px;margin-bottom:18px;padding-bottom:18px;border-bottom:1px solid var(--border)">
      <div class="bug-form-grid" style="display:grid;grid-template-columns:2fr 1fr 1fr;gap:9px">
        <div><label style="font-size:11px;color:var(--dim);display:block;margin-bottom:4px">Bug Title / ID *</label>
          <input id="b_title" class="inp" placeholder="e.g. BUG-123 Login fails on Safari"/></div>
        <div><label style="font-size:11px;color:var(--dim);display:block;margin-bottom:4px">Severity</label>
          <select id="b_severity" class="inp"><option value="CRITICAL">ğŸ”´ Critical</option><option value="HIGH">ğŸŸ  High</option><option value="MEDIUM" selected>ğŸŸ¡ Medium</option><option value="LOW">ğŸŸ¢ Low</option></select></div>
        <div><label style="font-size:11px;color:var(--dim);display:block;margin-bottom:4px">Status</label>
          <select id="b_status" class="inp"><option value="OPEN">Open</option><option value="IN_FIX">In Fix</option><option value="FIXED">Fixed</option><option value="CLOSED">Closed</option><option value="REOPEN">Reopened</option></select></div>
      </div>
      <div><label style="font-size:11px;color:var(--dim);display:block;margin-bottom:4px">Steps to Reproduce</label>
        <textarea id="b_steps" class="inp" rows="3" placeholder="1. Go to login page&#10;2. Enter credentials&#10;3. Click Login â†’ Error appears"></textarea></div>
      <div style="display:flex;justify-content:flex-end">
        <button class="btn" onclick="addBug()" style="background:#dc2626;color:#fff;padding:8px 18px">+ Log Bug</button>
      </div>
    </div>
    <div id="bugListInModal"></div>
    <div style="margin-top:14px;display:flex;justify-content:flex-end">
      <button class="btn" onclick="closeModal('bugModal')" style="background:#334155;color:#e2e8f0;padding:9px 18px">Close</button>
    </div>
  </div>
</div>

<!-- IMPORT BUGS MODAL -->
<div id="importModal" class="modal-bg hidden">
  <div class="modal" style="max-width:760px">
    <div style="font-family:'Space Grotesk';font-weight:700;font-size:17px;color:var(--text);margin-bottom:6px">ğŸ“¥ Import Bugs</div>
    <div style="font-size:12px;color:var(--dim);margin-bottom:16px">Paste copied bug rows from your sheet OR load from Google Sheet by your name</div>
    
    <!-- Tab picker -->
    <div style="display:flex;gap:4px;margin-bottom:16px;background:var(--bg);border-radius:8px;padding:3px;width:fit-content">
      <button class="rtab" id="itab-paste" onclick="setImportTab('paste')" style="background:#1e40af;color:#fff;font-size:12px;padding:5px 14px">ğŸ“‹ Paste Text</button>
      <button class="rtab" id="itab-sheet" onclick="setImportTab('sheet')" style="background:transparent;color:var(--dim);font-size:12px;padding:5px 14px">ğŸ“Š Google Sheet</button>
    </div>

    <!-- Paste tab -->
    <div id="import-paste-tab">
      <div style="font-size:11px;color:var(--dim);margin-bottom:8px">Paste the copied bug rows from your spreadsheet. Each bug should have: Title, Status, Severity</div>
      <textarea id="importPasteArea" class="import-area" placeholder="Paste your copied bug rows hereâ€¦&#10;&#10;Example:&#10;BuggedMediumStore- Free tag is misaligned...&#10;Bug verified/QA PassHighLogin fails on Safari..."></textarea>
      <div style="display:flex;gap:8px;margin-top:10px;justify-content:flex-end">
        <button class="btn" onclick="previewImport()" style="background:#7c3aed;color:#fff;padding:8px 16px;font-size:12px">ğŸ” Preview</button>
        <button class="btn" onclick="closeModal('importModal')" style="background:#334155;color:#e2e8f0;padding:8px 16px;font-size:12px">Cancel</button>
      </div>
    </div>

    <!-- Sheet tab -->
    <div id="import-sheet-tab" class="hidden">
      <div style="font-size:11px;color:var(--dim);margin-bottom:10px">Load bugs from Google Sheet where you are listed as tester</div>
      <div class="import-url-grid" style="display:grid;grid-template-columns:1fr auto;gap:8px;margin-bottom:10px">
        <input id="sheetUrlInput" class="inp" placeholder="Paste your Google Sheet URLâ€¦" value="https://docs.google.com/spreadsheets/d/1sd2RCxnJqw1gkP-GEQ2Yphg_ZiThkfxTZt9dkj-xtX0/edit?usp=sharing"/>
        <button class="btn" onclick="loadSheetBugs()" style="background:#059669;color:#fff;padding:8px 16px;font-size:12px" id="loadSheetBtn">Load Bugs</button>
      </div>
      <div style="font-size:11px;color:var(--muted);background:var(--surface2);border-radius:8px;padding:10px;margin-bottom:10px">
        â„¹ï¸ The sheet must be set to "Anyone with link can view". Only rows with <strong>status "Bugged"</strong> or <strong>"Reopened"</strong> and your name (<strong id="sheetNameLabel">Kunal</strong>) as tester will be imported as bugs.
      </div>
      <div id="sheetLoadStatus" style="font-size:12px;color:var(--muted);min-height:24px"></div>
    </div>

    <!-- Preview area -->
    <div id="importPreview" class="hidden" style="margin-top:14px">
      <div style="font-family:'Space Grotesk';font-weight:700;font-size:13px;margin-bottom:10px;color:var(--text)">Preview â€” <span id="previewCount">0</span> bugs found</div>
      <div id="previewList" style="max-height:260px;overflow-y:auto"></div>
      <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
        <button class="btn" onclick="closeModal('importModal')" style="background:#334155;color:#e2e8f0;padding:9px 18px">Cancel</button>
        <button class="btn" onclick="confirmImport()" style="background:#dc2626;color:#fff;padding:9px 18px" id="confirmImportBtn">âœ… Import All</button>
      </div>
    </div>
  </div>
</div>

<!-- SCRATCH PAD -->
<div id="scratchModal" class="modal-bg hidden">
  <div class="modal" style="max-width:700px">
    <div style="font-family:'Space Grotesk';font-weight:700;font-size:17px;color:var(--text);margin-bottom:3px">ğŸ“ Quick Notes</div>
    <div style="font-size:11px;color:var(--dim);margin-bottom:12px">Auto-synced across devices in real-time.</div>
    <textarea id="scratchText" class="scratchpad" rows="14" oninput="onScratchChange()"></textarea>
    <div style="display:flex;align-items:center;justify-content:space-between;margin-top:10px">
      <span id="scratchCount" style="font-size:11px;color:var(--dim)"></span>
      <div style="display:flex;gap:8px">
        <button class="btn" onclick="clearScratch()" style="background:#334155;color:#e2e8f0;padding:7px 14px;font-size:12px">ğŸ—‘ Clear</button>
        <button class="btn" onclick="closeModal('scratchModal')" style="background:#0369a1;color:#fff;padding:7px 14px;font-size:12px">âœ“ Done</button>
      </div>
    </div>
  </div>
</div>

<!-- EOD MODAL -->
<div id="eodModal" class="modal-bg hidden">
  <div class="eod-modal">
    <div style="background:linear-gradient(135deg,#1c1917,#1e1b4b);border-bottom:1px solid #f59e0b44;padding:20px 24px">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px">
        <div>
          <div style="font-family:'Space Grotesk';font-weight:700;font-size:20px;color:#fbbf24">ğŸ“¤ End of Day Report</div>
          <div id="eodDateTime" style="font-size:12px;color:#94a3b8;margin-top:2px"></div>
        </div>
        <button class="btn" onclick="closeModal('eodModal')" style="background:#334155;color:#e2e8f0;padding:6px 14px;font-size:13px">âœ• Close</button>
      </div>
      <div id="eodStats" style="display:flex;gap:9px;flex-wrap:wrap"></div>
    </div>
    <div style="padding:20px 24px;display:flex;flex-direction:column;gap:14px">
      <div class="eod-name-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:11px">
        <div><label style="font-size:11px;color:var(--dim);display:block;margin-bottom:4px">ğŸ‘¤ Your Name</label>
          <input id="eod_name" class="inp" placeholder="e.g. Kunal Jade" oninput="localStorage.setItem('qa_name',this.value);updateEOD()"/></div>
        <div><label style="font-size:11px;color:var(--dim);display:block;margin-bottom:4px">ğŸ‘” Manager Name</label>
          <input id="eod_mgr" class="inp" placeholder="e.g. Rahul, Teamâ€¦" oninput="localStorage.setItem('qa_mgr',this.value);updateEOD()"/></div>
      </div>
      <div><label style="font-size:11px;color:var(--dim);display:block;margin-bottom:4px">ğŸ“ Additional Notes</label>
        <textarea id="eod_notes" class="inp" rows="2" oninput="updateEOD()"></textarea></div>
      <div style="display:flex;gap:5px;background:var(--bg);border-radius:9px;padding:4px;width:fit-content">
        <button class="rtab" id="rtab-email" onclick="setRTab('email')" style="background:#1e40af;color:#fff">ğŸ“§ Email</button>
        <button class="rtab" id="rtab-whatsapp" onclick="setRTab('whatsapp')" style="background:transparent;color:var(--dim)">ğŸ’¬ WhatsApp</button>
      </div>
      <div>
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:7px">
          <div id="rFmtLabel" style="font-size:11px;color:var(--dim)">ğŸ“§ Paste into Gmail / Outlook</div>
          <button class="btn" id="copyBtn" onclick="copyReport()" style="background:#1e40af;color:#fff;padding:7px 16px;font-size:12px">ğŸ“‹ Copy</button>
        </div>
        <pre id="rptPreview" class="rpt-pre"></pre>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn" id="copyBtn2" onclick="copyReport()" style="background:linear-gradient(135deg,#f59e0b,#ef4444);color:#fff;padding:12px 0;font-size:14px;flex:1;font-weight:700;border-radius:10px;justify-content:center">ğŸ“‹ Copy &amp; Send to Manager</button>
        <button class="btn" onclick="downloadRpt()" style="background:#334155;color:#e2e8f0;padding:12px 18px;font-size:13px;border-radius:10px">â¬‡ï¸ .txt</button>
      </div>
      <div id="manualBox" class="hidden">
        <div style="background:#fef3c7;border:1.5px solid #f59e0b;border-radius:9px;padding:12px">
          <div style="font-size:12px;color:#92400e;font-weight:700;margin-bottom:6px">ğŸ“‹ Click inside â†’ Ctrl+A â†’ Ctrl+C</div>
          <textarea id="manualText" onclick="this.select()" style="width:100%;height:170px;background:#fff;color:#1e293b;border:1px solid #d97706;border-radius:7px;padding:10px;font-family:'Courier New',monospace;font-size:11px;line-height:1.7;resize:vertical"></textarea>
          <button class="btn" onclick="document.getElementById('manualBox').classList.add('hidden')" style="background:#334155;color:#e2e8f0;padding:4px 11px;font-size:11px;margin-top:6px">âœ•</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// ============================================================
// CONFIG
// ============================================================
const SHEET_URL = "https://qatracker.kunal-249.workers.dev";

const STATUS = {
  TODO:{label:"To Do",color:"#6b7280",bg:"#f3f4f6"},
  IN_PROGRESS:{label:"In Progress",color:"#d97706",bg:"#fef3c7"},
  TESTING:{label:"Testing",color:"#7c3aed",bg:"#ede9fe"},
  BLOCKED:{label:"Blocked",color:"#dc2626",bg:"#fee2e2"},
  DONE:{label:"Done",color:"#059669",bg:"#d1fae5"},
};
const PRI = {HIGH:{c:"#dc2626"},MEDIUM:{c:"#d97706"},LOW:{c:"#059669"}};
const BSTC = {OPEN:"#dc2626",IN_FIX:"#d97706",FIXED:"#059669",CLOSED:"#6b7280",REOPEN:"#7c3aed"};

// ============================================================
// STATE
// ============================================================
let tasks = [];
let bugs  = [];
let scrum = {yesterday:"",today:"",blockers:"",mood:"ğŸ˜Š",lastModified:0};
let scratch = "";
let TM = {};
let globalInterval = null;
let activeTab      = "board";
let currentFilter  = "ALL";
let editingId      = null;
let rTab           = "email";
let isLight        = localStorage.getItem("qa_theme")==="light";

// Auto-sync state
let pendingSyncTimer = null;
let pollingInterval  = null;
let lastKnownVersion = 0; // track server version to detect changes from other devices
let isSyncing = false;
let pendingImportBugs = [];
let importTab = "paste";

// ============================================================
// UTILS
// ============================================================
function load(k,def){try{return JSON.parse(localStorage.getItem(k)||"null")||def;}catch{return def;}}
function save(k,v){localStorage.setItem(k,JSON.stringify(v));}
function dk(){return new Date().toISOString().split("T")[0];}
function getToday(){return new Date().toLocaleDateString("en-IN",{weekday:"long",year:"numeric",month:"long",day:"numeric"});}
function getTime(){return new Date().toLocaleTimeString("en-IN",{hour:"2-digit",minute:"2-digit"});}
function esc(s){return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");}
function fmtT(sec){if(!sec||sec<0)return"0:00";const h=Math.floor(sec/3600),m=Math.floor((sec%3600)/60),s=sec%60;return h>0?`${h}h ${m}m`:`${m}:${String(s).padStart(2,"0")}`;}

function setCloud(state,msg){
  const dot=document.getElementById("cloudDot"),lbl=document.getElementById("cloudLabel");
  if(!dot||!lbl)return;
  dot.className="cloud-dot "+(state==="ok"?"cloud-ok":state==="err"?"cloud-err":"cloud-sync");
  lbl.textContent=msg;
}

function setAutoSyncStatus(active){
  const dot=document.getElementById("autoSyncDot"), lbl=document.getElementById("autoSyncLabel");
  if(dot)dot.className="cloud-dot "+(active?"sync-pulse":"cloud-ok");
  if(lbl)lbl.textContent=active?"Syncingâ€¦":"Auto-sync: ON";
}

// ============================================================
// MERGE LOGIC â€” merge two arrays by id, keeping newest lastModified
// ============================================================
function mergeTasks(local, remote){
  const map = new Map();
  // start with local
  local.forEach(t => map.set(String(t.id), t));
  // remote overwrites if newer
  remote.forEach(t => {
    const key = String(t.id);
    const existing = map.get(key);
    if(!existing || (t.lastModified||0) >= (existing.lastModified||0)){
      map.set(key, t);
    }
  });
  return Array.from(map.values());
}

function mergeBugs(local, remote){
  const map = new Map();
  local.forEach(b => map.set(String(b.id), b));
  remote.forEach(b => {
    const key = String(b.id);
    const existing = map.get(key);
    if(!existing || (b.lastModified||0) >= (existing.lastModified||0)){
      map.set(key, b);
    }
  });
  return Array.from(map.values());
}

function mergeScrum(local, remote){
  if(!remote || !remote.lastModified) return local;
  if(!local || !local.lastModified) return remote;
  return (remote.lastModified >= local.lastModified) ? remote : local;
}

function mergeScratch(local, remote){
  if(!remote || remote.trim().length === 0) return local;
  if(!local || local.trim().length === 0) return remote;
  // If both have content, keep the longer/newer one
  // We can't truly merge text, so keep the one with more content
  return remote.length >= local.length ? remote : local;
}

// ============================================================
// INIT
// ============================================================
(function init(){
  if(isLight){document.body.classList.add("light");document.getElementById("themeBtn").textContent="â˜€ï¸ Light";}
  document.getElementById("todayLabel").textContent=getToday();
  document.getElementById("myNameInput").value=localStorage.getItem("qa_name")||"Kunal";
  document.getElementById("sprintInput").value=localStorage.getItem("qa_sprint")||"";
  document.getElementById("releaseInput").value=localStorage.getItem("qa_release")||"";
  document.getElementById("reminderTime").value=localStorage.getItem("qa_reminder_time")||"18:00";
  
  // Load from local cache first for instant display
  tasks = load("qa_tasks",[]);
  bugs  = load("qa_bugs",[]);
  scrum = load("qa_scrum_"+dk(),{yesterday:"",today:"",blockers:"",mood:"ğŸ˜Š",lastModified:0});
  scratch = localStorage.getItem("qa_scratch")||"";
  tasks.forEach(t=>{if(!TM[t.id])TM[t.id]={elapsed:t.timerTotal||0,state:"idle",startedAt:null};});
  
  startGlobalTick();
  renderAll();
  
  // Then sync with server (merge)
  syncAndMerge(false);
  
  // Poll for changes from other devices every 15 seconds
  startPolling();
  
  scheduleReminder();
  Notification?.permission==="default"&&Notification?.requestPermission();
})();

// ============================================================
// AUTO-SYNC â€” triggered on any data change
// ============================================================
function markDirty(){
  // Debounce: sync 2 seconds after last change
  if(pendingSyncTimer) clearTimeout(pendingSyncTimer);
  setAutoSyncStatus(true);
  pendingSyncTimer = setTimeout(()=>{
    syncAndMerge(false);
  }, 2000);
}

// Polling: check server every 15s for changes from other devices
function startPolling(){
  if(pollingInterval) clearInterval(pollingInterval);
  pollingInterval = setInterval(()=>{
    // Only poll if we're not currently syncing
    if(!isSyncing && !pendingSyncTimer){
      pollForChanges();
    }
  }, 15000);
}

async function pollForChanges(){
  try{
    const url = SHEET_URL + "?date=" + dk() + "&t=" + Date.now() + "&callback=window.QA_POLL_CB";
    await new Promise((resolve, reject) => {
      const timeout = setTimeout(()=>reject(new Error("timeout")), 5000);
      window.QA_POLL_CB = (data) => {
        clearTimeout(timeout);
        resolve(data);
        if(!data) return;
        // Check if server has newer data
        const serverVersion = data._version || data._ts || 0;
        if(serverVersion > lastKnownVersion){
          lastKnownVersion = serverVersion;
          applyRemoteData(data);
        }
      };
      const s = document.createElement('script');
      s.src = url;
      s.onerror = ()=>{clearTimeout(timeout);reject(new Error("err"));};
      document.head.appendChild(s);
      setTimeout(()=>{try{document.head.removeChild(s);}catch(e){}}, 6000);
    });
  }catch(e){
    // Silent fail for polling
  }
}

// Apply remote data using merge (not overwrite)
function applyRemoteData(data){
  let changed = false;
  
  if(Array.isArray(data.tasks)){
    const remote = data.tasks.map(t=>({...t,id:Number(t.id)||t.id,timerTotal:Number(t.timerTotal)||0,lastModified:t.lastModified||0}));
    const merged = mergeTasks(tasks, remote);
    if(JSON.stringify(merged) !== JSON.stringify(tasks)){
      tasks = merged;
      tasks.forEach(t=>{if(!TM[t.id])TM[t.id]={elapsed:t.timerTotal||0,state:"idle",startedAt:null};});
      save("qa_tasks", tasks);
      changed = true;
    }
  }
  
  if(Array.isArray(data.bugs)){
    const remote = data.bugs.map(b=>({...b,id:Number(b.id)||b.id,lastModified:b.lastModified||0}));
    const merged = mergeBugs(bugs, remote);
    if(JSON.stringify(merged) !== JSON.stringify(bugs)){
      bugs = merged;
      save("qa_bugs", bugs);
      changed = true;
    }
  }
  
  if(data.scrum){
    const merged = mergeScrum(scrum, data.scrum);
    if(JSON.stringify(merged) !== JSON.stringify(scrum)){
      scrum = merged;
      save("qa_scrum_"+dk(), scrum);
      changed = true;
    }
  }
  
  if(data.scratch !== undefined){
    const merged = mergeScratch(scratch, data.scratch);
    if(merged !== scratch){
      scratch = merged;
      localStorage.setItem("qa_scratch", scratch);
      const el = document.getElementById("scratchText");
      if(el && el.value !== scratch) el.value = scratch;
      changed = true;
    }
  }
  
  if(changed){
    renderAll();
    const li = document.getElementById("liveIndicator");
    if(li){li.style.display="inline";setTimeout(()=>li.style.display="none", 3000);}
    const now = new Date().toLocaleTimeString();
    document.getElementById("lastSyncInfo").textContent = "ğŸ”„ Updated: " + now;
  }
}

// Main sync: push local + merge with remote response
async function syncAndMerge(showFeedback=false){
  if(isSyncing) return;
  isSyncing = true;
  setCloud("sync","Syncingâ€¦");
  setAutoSyncStatus(true);
  
  try{
    tasks.forEach(t=>{if(!t.lastModified)t.lastModified=Date.now();});
    bugs.forEach(b=>{if(!b.lastModified)b.lastModified=Date.now();});
    if(!scrum.lastModified) scrum.lastModified=Date.now();
    
    const payload = JSON.stringify({
      tasks,
      bugs,
      scrum: (scrum.yesterday||scrum.today||scrum.blockers||scrum.mood!=='ğŸ˜Š') ? scrum : null,
      scratch,
      date: dk(),
      name: localStorage.getItem("qa_name")||"",
      _merge: true // tell server this is a merge request
    });
    
    const response = await fetch(SHEET_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: payload
    });
    
    // Server returns merged data back
    let serverData = null;
    try{ serverData = await response.json(); }catch(e){}
    
    if(serverData && (serverData.tasks || serverData.bugs)){
      applyRemoteData(serverData);
      if(serverData._version) lastKnownVersion = serverData._version;
    }
    
    // Also cache to localStorage as backup
    save("qa_tasks", tasks);
    save("qa_bugs", bugs);
    save("qa_scrum_"+dk(), scrum);
    localStorage.setItem("qa_scratch", scratch);
    
    const now = new Date().toLocaleTimeString();
    document.getElementById("lastSyncInfo").textContent = "â˜ï¸ Synced: " + now;
    setCloud("ok","Synced âœ“");
    if(showFeedback) showSyncBar("âœ… Synced across all devices!");
    
  }catch(e){
    // Fallback: just save locally
    save("qa_tasks", tasks);
    save("qa_bugs", bugs);
    save("qa_scrum_"+dk(), scrum);
    localStorage.setItem("qa_scratch", scratch);
    const now = new Date().toLocaleTimeString();
    document.getElementById("lastSyncInfo").textContent = "ğŸ’¾ Local: " + now;
    setCloud("ok","Local mode");
    if(showFeedback) showSyncBar("âš ï¸ Offline â€” saved locally, will sync when online.");
  }finally{
    isSyncing = false;
    setAutoSyncStatus(false);
    pendingSyncTimer = null;
  }
}

function showSyncBar(m){
  const b=document.getElementById("syncBar");
  b.textContent=m;
  b.classList.remove("hidden");
  setTimeout(()=>b.classList.add("hidden"),3000);
}

// ============================================================
// INPUT CHANGE HANDLERS (trigger auto-sync)
// ============================================================
function onNameChange(v){ localStorage.setItem('qa_name',v); markDirty(); }
function onSprintChange(v){ localStorage.setItem('qa_sprint',v); markDirty(); }
function onReleaseChange(v){ localStorage.setItem('qa_release',v); markDirty(); }
function onScratchChange(){
  const v = document.getElementById("scratchText")?.value||"";
  scratch = v;
  localStorage.setItem("qa_scratch", v);
  updScratchCnt();
  markDirty();
}

// ============================================================
// TIMER
// ============================================================
function startGlobalTick(){
  if(globalInterval)clearInterval(globalInterval);
  globalInterval=setInterval(()=>{
    Object.keys(TM).forEach(id=>{
      const tm=TM[id];if(tm.state!=="running")return;
      const total=tm.elapsed+Math.floor((Date.now()-tm.startedAt)/1000);
      const pill=document.getElementById("tpill_"+id);
      if(pill){pill.textContent="â± "+fmtT(total);pill.className="tpill tpill-run";}
    });
    const runId=Object.keys(TM).find(id=>TM[id].state==="running");
    const badge=document.getElementById("activeTimerBadge");
    const label=document.getElementById("activeTimerLabel");
    if(runId&&badge&&label){
      const t=tasks.find(t=>t.id==runId),tm=TM[runId];
      const total=tm.elapsed+Math.floor((Date.now()-tm.startedAt)/1000);
      label.textContent=(t?t.title.substring(0,22)+"â€¦":"Task")+" | "+fmtT(total);
      badge.classList.remove("hidden");badge.style.display="flex";
    }else if(badge){badge.classList.add("hidden");}
  },1000);
}

function timerStart(id){
  Object.keys(TM).forEach(oid=>{if(oid!=id&&TM[oid].state==="running")timerPause(oid);});
  if(!TM[id])TM[id]={elapsed:tasks.find(t=>t.id==id)?.timerTotal||0,state:"idle",startedAt:null};
  TM[id].state="running";TM[id].startedAt=Date.now();refreshTimerBtn(id);
}
function timerPause(id){
  if(!TM[id]||TM[id].state!=="running")return;
  TM[id].elapsed+=Math.floor((Date.now()-TM[id].startedAt)/1000);
  TM[id].state="paused";TM[id].startedAt=null;
  tasks=tasks.map(t=>t.id==id?{...t,timerTotal:TM[id].elapsed,lastModified:Date.now()}:t);
  save("qa_tasks",tasks);markDirty();refreshTimerBtn(id);
}
function timerReset(id){
  TM[id]={elapsed:0,state:"idle",startedAt:null};
  tasks=tasks.map(t=>t.id==id?{...t,timerTotal:0,lastModified:Date.now()}:t);
  save("qa_tasks",tasks);markDirty();
  const pill=document.getElementById("tpill_"+id);
  if(pill){pill.textContent="â± 0:00";pill.className="tpill tpill-idle";}
  refreshTimerBtn(id);
}
function timerStop(id){
  timerPause(id);
  const pill=document.getElementById("tpill_"+id);
  if(pill&&TM[id]){pill.textContent="â± "+fmtT(TM[id].elapsed);pill.className="tpill tpill-idle";}
  refreshTimerBtn(id);
}
function getTimerElapsed(id){
  const tm=TM[id];if(!tm)return tasks.find(t=>t.id==id)?.timerTotal||0;
  if(tm.state==="running")return tm.elapsed+Math.floor((Date.now()-tm.startedAt)/1000);
  return tm.elapsed;
}
function refreshTimerBtn(id){
  const wrap=document.getElementById("tbwrap_"+id);if(!wrap)return;
  const tm=TM[id]||{state:"idle",elapsed:tasks.find(t=>t.id==id)?.timerTotal||0};
  const el=getTimerElapsed(id);
  const pill=document.getElementById("tpill_"+id);
  if(pill){pill.textContent="â± "+fmtT(el);pill.className="tpill "+(tm.state==="running"?"tpill-run":tm.state==="paused"?"tpill-pause":"tpill-idle");}
  wrap.innerHTML=timerBtnsHTML(id,tm.state);
}
function timerBtnsHTML(id,state){
  if(state==="running")return`<button class="tbtn" onclick="timerPause(${id})" style="background:#d9770622;color:#d97706">â¸ Pause</button><button class="tbtn" onclick="timerReset(${id})" style="background:#dc262622;color:#f87171">â†º</button>`;
  if(state==="paused")return`<button class="tbtn" onclick="timerStart(${id})" style="background:#05966922;color:#34d399">â–¶ Resume</button><button class="tbtn" onclick="timerStop(${id})" style="background:#64748b22;color:#94a3b8">â¹</button><button class="tbtn" onclick="timerReset(${id})" style="background:#dc262622;color:#f87171">â†º</button>`;
  return`<button class="tbtn" onclick="timerStart(${id})" style="background:#05966922;color:#34d399">â–¶ Start</button>`;
}

// ============================================================
// STATS
// ============================================================
function getStats(){return{total:tasks.length,done:tasks.filter(t=>t.status==="DONE").length,prog:tasks.filter(t=>t.status==="IN_PROGRESS"||t.status==="TESTING").length,blocked:tasks.filter(t=>t.blocker&&t.status!=="DONE").length,remaining:tasks.filter(t=>t.status!=="DONE").length,openBugs:bugs.filter(b=>b.status==="OPEN"||b.status==="REOPEN").length};}
function renderStats(){
  const s=getStats(),pct=s.total?Math.round(s.done/s.total*100):0;
  document.getElementById("statsRow").innerHTML=[
    {l:"Total",v:s.total,icon:"ğŸ“",c:"#3b82f6"},
    {l:"In Progress",v:s.prog,icon:"âš¡",c:"#d97706"},
    {l:"Remaining",v:s.remaining,icon:"â³",c:"#7c3aed"},
    {l:"Blocked",v:s.blocked,icon:"ğŸš§",c:"#dc2626"},
    {l:"Done",v:s.done,icon:"âœ…",c:"#059669",pct},
    {l:"Open Bugs",v:s.openBugs,icon:"ğŸ›",c:"#f97316"},
  ].map(x=>`<div style="background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:13px 15px">
    <div style="font-size:17px;margin-bottom:4px">${x.icon}</div>
    <div style="font-size:22px;font-weight:700;color:${x.c};font-family:'Space Grotesk'">${x.v}</div>
    <div style="font-size:10px;color:var(--dim);margin-top:1px">${x.l}</div>
    ${x.pct!=null&&s.total>0?`<div class="pb" style="margin-top:7px"><div class="pb-fill" style="background:linear-gradient(90deg,#3b82f6,#06b6d4);width:${x.pct}%"></div></div><div style="font-size:9px;color:var(--dim);margin-top:2px">${x.pct}%</div>`:""}
  </div>`).join("");
}

function getFiltered(){
  const q=(document.getElementById("searchInput")?.value||"").toLowerCase();
  return tasks.filter(t=>(currentFilter==="ALL"||t.status===currentFilter)&&(t.title.toLowerCase().includes(q)||(t.notes||"").toLowerCase().includes(q)));
}

function cardHTML(t){
  const state=(TM[t.id]||{state:"idle"}).state,elapsed=getTimerElapsed(t.id);
  const pillCls=state==="running"?"tpill-run":state==="paused"?"tpill-pause":"tpill-idle";
  return`<div class="tcard" id="card_${t.id}">
    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px">
      <span style="font-size:12px;font-weight:600;color:var(--text);flex:1;line-height:1.4">${esc(t.title)}</span>
      <div style="display:flex;gap:3px;margin-left:5px;flex-shrink:0">
        <button class="btn" onclick="openTaskForm(${t.id})" style="background:#1e40af22;color:#60a5fa;padding:2px 6px;font-size:10px">âœï¸</button>
        <button class="btn" onclick="delTask(${t.id})" style="background:#dc262622;color:#f87171;padding:2px 6px;font-size:10px">ğŸ—‘</button>
      </div>
    </div>
    <div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:${t.blocker||t.notes?6:0}px">
      <span class="badge" style="background:var(--border);color:var(--muted)">${t.type}</span>
      <span style="color:${PRI[t.priority]?.c||"#94a3b8"};font-size:10px;font-weight:700">${t.priority}</span>
      ${t.sprint?`<span class="badge" style="background:#1e40af22;color:#60a5fa">ğŸ·ï¸ ${esc(t.sprint)}</span>`:""}
      ${t.env?`<span class="badge" style="background:var(--surface);color:var(--dim)">ğŸŒ ${esc(t.env)}</span>`:""}
    </div>
    ${t.blocker?`<div style="background:#dc262611;border:1px solid #dc262633;border-radius:5px;padding:3px 7px;margin-bottom:5px;font-size:10px;color:#f87171">ğŸš§ ${esc(t.blocker)}</div>`:""}
    ${t.notes?`<div style="font-size:10px;color:var(--dim);margin-bottom:6px;line-height:1.4">${esc(t.notes.substring(0,70))}${t.notes.length>70?"â€¦":""}</div>`:""}
    <div style="display:flex;align-items:center;gap:5px;margin-bottom:6px;flex-wrap:wrap">
      <span id="tpill_${t.id}" class="tpill ${pillCls}">â± ${fmtT(elapsed)}</span>
      <span id="tbwrap_${t.id}" style="display:flex;gap:3px">${timerBtnsHTML(t.id,state)}</span>
    </div>
    <select onchange="updateStatus(${t.id},this.value)" style="width:100%;background:${STATUS[t.status]?.bg}33;color:${STATUS[t.status]?.color};border:1px solid ${STATUS[t.status]?.color}55;border-radius:6px;padding:5px 8px;font-size:11px;font-weight:700;cursor:pointer;font-family:inherit">
      ${Object.entries(STATUS).map(([k,v])=>`<option value="${k}" ${t.status===k?"selected":""}>${v.label}</option>`).join("")}
    </select>
    <div style="font-size:9px;color:var(--border);margin-top:4px">${t.createdAt||""}</div>
  </div>`;
}

function renderBoard(){
  const f=getFiltered();
  document.getElementById("view-board").innerHTML=`<div class="board-grid" style="display:grid;grid-template-columns:repeat(5,1fr);gap:10px">
    ${Object.entries(STATUS).map(([k,s])=>{
      const col=f.filter(t=>t.status===k);
      return`<div style="background:var(--surface);border-radius:11px;padding:12px;border:1px solid var(--border)">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
          <span style="font-weight:700;font-size:12px;color:${s.color}">${s.label}</span>
          <span style="background:${s.bg}33;color:${s.color};border-radius:20px;padding:1px 8px;font-size:11px;font-weight:700">${col.length}</span>
        </div>
        ${col.map(t=>cardHTML(t)).join("")}
        ${!col.length?`<div style="color:var(--border);font-size:11px;text-align:center;padding:14px 0">Empty</div>`:""}
      </div>`;
    }).join("")}
  </div>`;
}

function renderList(){
  const f=getFiltered();
  document.getElementById("view-list").innerHTML=`<div class="table-wrap" style="overflow-x:auto;-webkit-overflow-scrolling:touch"><div style="background:var(--surface);border-radius:11px;border:1px solid var(--border);min-width:900px">
    <table><thead><tr>${["Task","Type","Pri","Status","Sprint","Env","Est/Act","â± Timer","Blocker","Actions"].map(h=>`<th>${h}</th>`).join("")}</tr></thead>
    <tbody>${!f.length?`<tr><td colspan="10" style="padding:34px;text-align:center;color:var(--dim)">No tasks yet. Click + Task!</td></tr>`:
      f.map(t=>{
        const state=(TM[t.id]||{state:"idle"}).state,elapsed=getTimerElapsed(t.id);
        const pillCls=state==="running"?"tpill-run":state==="paused"?"tpill-pause":"tpill-idle";
        return`<tr>
          <td style="max-width:180px"><div style="font-weight:500;color:var(--text)">${esc(t.title)}</div>${t.notes?`<div style="font-size:10px;color:var(--dim)">${esc(t.notes.substring(0,50))}</div>`:""}</td>
          <td style="color:var(--muted);font-size:11px">${t.type}</td>
          <td><span style="color:${PRI[t.priority]?.c};font-size:11px;font-weight:700">${t.priority}</span></td>
          <td><select onchange="updateStatus(${t.id},this.value)" style="background:${STATUS[t.status]?.bg}33;color:${STATUS[t.status]?.color};border:1px solid ${STATUS[t.status]?.color}55;border-radius:6px;padding:3px 7px;font-size:11px;font-weight:700;cursor:pointer;font-family:inherit">${Object.entries(STATUS).map(([k,v])=>`<option value="${k}" ${t.status===k?"selected":""}>${v.label}</option>`).join("")}</select></td>
          <td style="font-size:11px;color:var(--dim)">${t.sprint||"â€”"}</td>
          <td style="font-size:11px;color:var(--muted)">${t.env||"â€”"}</td>
          <td style="font-size:11px;color:var(--muted)">${t.estimate||"â€”"} / ${t.actual||"â€”"}</td>
          <td><div style="display:flex;align-items:center;gap:4px;flex-wrap:wrap"><span id="tpill_${t.id}" class="tpill ${pillCls}">â± ${fmtT(elapsed)}</span><span id="tbwrap_${t.id}" style="display:flex;gap:3px">${timerBtnsHTML(t.id,state)}</span></div></td>
          <td>${t.blocker?`<span style="color:#f87171;font-size:10px">ğŸš§ ${esc(t.blocker)}</span>`:`<span style="color:var(--border)">â€”</span>`}</td>
          <td><div style="display:flex;gap:4px"><button class="btn" onclick="openTaskForm(${t.id})" style="background:#1e40af22;color:#60a5fa;padding:3px 8px;font-size:11px">Edit</button><button class="btn" onclick="delTask(${t.id})" style="background:#dc262622;color:#f87171;padding:3px 8px;font-size:11px">Del</button></div></td>
        </tr>`;
      }).join("")}</tbody></table></div></div>`;
}

function renderWeekly(){
  const today=new Date(),day=today.getDay(),mon=new Date(today);
  mon.setDate(today.getDate()-(day===0?6:day-1));
  const days=[];for(let i=0;i<7;i++){const d=new Date(mon);d.setDate(mon.getDate()+i);days.push(d);}
  const todayStr=dk();
  document.getElementById("view-weekly").innerHTML=`
    <div class="weekly-grid" style="display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-bottom:14px">
      ${days.map(d=>{
        const key=d.toISOString().split("T")[0],isT=key===todayStr;
        const saved=isT?tasks:[];
        const done=saved.filter(t=>t.status==="DONE").length,tot=saved.length,pct=tot?Math.round(done/tot*100):0;
        return`<div class="wday ${isT?"today-col":""}">
          <div style="font-weight:700;font-size:12px;color:${isT?"#3b82f6":"var(--muted)"}">${d.toLocaleDateString("en-IN",{weekday:"short"})}</div>
          <div style="font-size:10px;color:var(--dim);margin-bottom:8px">${d.toLocaleDateString("en-IN",{day:"numeric",month:"short"})}</div>
          ${isT?`<div style="font-size:12px;color:var(--text);font-weight:600">${tot} tasks</div><div style="font-size:10px;color:#059669;margin-top:2px">âœ… ${done} done</div><div style="font-size:10px;color:#d97706">âš¡ ${tasks.filter(t=>t.status==="IN_PROGRESS").length} active</div><div style="font-size:10px;color:#dc2626">ğŸš§ ${tasks.filter(t=>t.blocker&&t.status!=="DONE").length} blocked</div><div class="pb" style="margin-top:6px"><div class="pb-fill" style="background:#059669;width:${pct}%"></div></div>`:`<div style="font-size:10px;color:var(--border);margin-top:4px">No data</div>`}
        </div>`;
      }).join("")}
    </div>
    <div style="background:var(--surface);border-radius:11px;padding:16px;border:1px solid var(--border)">
      <div style="font-family:'Space Grotesk';font-weight:700;font-size:13px;margin-bottom:12px;color:var(--text)">ğŸ“… Today's Tasks</div>
      ${!tasks.length?`<div style="color:var(--dim);text-align:center;padding:18px">No tasks today.</div>`:
        tasks.map(t=>`<div style="display:flex;align-items:center;gap:9px;padding:7px 0;border-bottom:1px solid var(--border)">
          <span style="font-size:15px">${t.status==="DONE"?"âœ…":t.status==="BLOCKED"?"ğŸš§":t.status==="IN_PROGRESS"?"âš¡":"ğŸ“‹"}</span>
          <div style="flex:1"><div style="font-size:12px;color:var(--text)">${esc(t.title)}</div><div style="font-size:10px;color:var(--dim)">${t.type} Â· ${t.priority}</div></div>
          <span style="font-size:11px;color:${STATUS[t.status]?.color};font-weight:600">${STATUS[t.status]?.label}</span>
          <span style="font-size:11px;font-family:'Space Grotesk';color:#06b6d4">${fmtT(getTimerElapsed(t.id))}</span>
        </div>`).join("")}
    </div>`;
}

function renderBugsView(){
  document.getElementById("view-bugs").innerHTML=`
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-bottom:12px">
      <button class="btn" onclick="openImportBugs()" style="background:#b45309;color:#fff;padding:8px 16px;font-size:13px">ğŸ“¥ Import Bugs</button>
      <button class="btn" onclick="openBugModal()" style="background:#dc2626;color:#fff;padding:8px 16px;font-size:13px">+ Log New Bug</button>
    </div>
    ${!bugs.length?`<div style="background:var(--surface);border-radius:11px;padding:38px;text-align:center;border:1px solid var(--border);color:var(--dim)">ğŸ‰ No bugs logged yet!</div>`:`
    <div style="background:var(--surface);border-radius:11px;border:1px solid var(--border);overflow:auto">
      <table><thead><tr>${["Bug / ID","Severity","Status","Steps","Assignee","Date","Del"].map(h=>`<th>${h}</th>`).join("")}</tr></thead>
      <tbody>${bugs.map(b=>`<tr>
        <td style="font-weight:500;color:var(--text);max-width:200px">${esc(b.title)}</td>
        <td><span class="sev-${b.severity}" style="font-size:11px">${b.severity}</span></td>
        <td><select onchange="updBugSt(${b.id},this.value)" style="background:${BSTC[b.status]}22;color:${BSTC[b.status]};border:1px solid ${BSTC[b.status]}55;border-radius:5px;padding:2px 7px;font-size:11px;font-weight:700;cursor:pointer;font-family:inherit">${["OPEN","IN_FIX","FIXED","CLOSED","REOPEN"].map(s=>`<option value="${s}" ${b.status===s?"selected":""}>${s}</option>`).join("")}</select></td>
        <td style="font-size:11px;color:var(--muted);max-width:200px">${esc((b.steps||"").substring(0,70))}</td>
        <td style="font-size:11px;color:var(--dim)">${esc(b.assignee||"â€”")}</td>
        <td style="font-size:10px;color:var(--dim)">${b.date}</td>
        <td><button class="btn" onclick="delBug(${b.id})" style="background:#dc262622;color:#f87171;padding:2px 7px;font-size:11px">ğŸ—‘</button></td>
      </tr>`).join("")}</tbody></table></div>`}`;
}

function renderCharts(){
  document.getElementById("view-charts").innerHTML=`<div class="charts-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
    ${[{id:"cStatus",title:"ğŸ“Š Tasks by Status"},{id:"cPriority",title:"ğŸ¯ Tasks by Priority"},{id:"cType",title:"ğŸ”§ Tasks by Type"},{id:"cBugs",title:"ğŸ› Bug Severity"}]
    .map(c=>`<div style="background:var(--surface);border-radius:11px;padding:18px;border:1px solid var(--border)"><div style="font-family:'Space Grotesk';font-weight:700;font-size:13px;margin-bottom:14px;color:var(--text)">${c.title}</div><div style="position:relative;width:100%"><canvas id="${c.id}" height="190"></canvas></div></div>`).join("")}
  </div>`;
  setTimeout(()=>{
    const types=["Bug","Test Case","Regression","Smoke","UAT","Automation","Review","Other"];
    pie("cStatus",Object.keys(STATUS).map(k=>tasks.filter(t=>t.status===k).length),Object.values(STATUS).map(s=>s.label),Object.values(STATUS).map(s=>s.color));
    pie("cPriority",["HIGH","MEDIUM","LOW"].map(p=>tasks.filter(t=>t.priority===p).length),["High","Medium","Low"],["#dc2626","#d97706","#059669"]);
    bar("cType",types.map(tp=>tasks.filter(t=>t.type===tp).length),types,["#3b82f6","#06b6d4","#7c3aed","#f59e0b","#059669","#f97316","#ec4899","#94a3b8"]);
    pie("cBugs",["OPEN","IN_FIX","FIXED","CLOSED","REOPEN"].map(s=>bugs.filter(b=>b.status===s).length),["Open","In Fix","Fixed","Closed","Reopened"],Object.values(BSTC));
  },60);
}
function pie(id,data,labels,colors){
  const cv=document.getElementById(id);if(!cv)return;
  const ctx=cv.getContext("2d"),W=cv.parentElement.offsetWidth||300;cv.width=W;cv.height=190;
  const total=data.reduce((a,b)=>a+b,0);
  if(!total){ctx.fillStyle="#475569";ctx.font="12px DM Sans";ctx.fillText("No data yet",W/2-38,95);return;}
  const cx=W/2-55,cy=95,r=75;let ang=-Math.PI/2;
  data.forEach((v,i)=>{if(!v)return;const sw=(v/total)*Math.PI*2;ctx.beginPath();ctx.moveTo(cx,cy);ctx.arc(cx,cy,r,ang,ang+sw);ctx.fillStyle=colors[i];ctx.fill();ang+=sw;});
  let ly=18;
  data.forEach((v,i)=>{if(!v)return;ctx.fillStyle=colors[i];ctx.fillRect(W-115,ly-10,11,11);ctx.fillStyle=isLight?"#1e293b":"#e2e8f0";ctx.font="11px DM Sans";ctx.fillText(`${labels[i]} (${v})`,W-98,ly);ly+=17;});
}
function bar(id,data,labels,colors){
  const cv=document.getElementById(id);if(!cv)return;
  const ctx=cv.getContext("2d"),W=cv.parentElement.offsetWidth||300;cv.width=W;cv.height=190;
  const max=Math.max(...data,1),bw=Math.max(4,Math.floor((W-40)/data.length)-4);
  data.forEach((v,i)=>{const x=24+i*(bw+4),h=Math.floor((v/max)*140);ctx.fillStyle=colors[i];ctx.fillRect(x,158-h,bw,h);ctx.fillStyle=isLight?"#1e293b":"#e2e8f0";ctx.font="8px DM Sans";ctx.textAlign="center";ctx.fillText(labels[i].substring(0,5),x+bw/2,174);if(v>0)ctx.fillText(v,x+bw/2,152-h);});
}

function renderReport(){
  const s=getStats(),bl=tasks.filter(t=>t.blocker&&t.status!=="DONE");
  const totalTime=tasks.reduce((a,t)=>a+getTimerElapsed(t.id),0);
  document.getElementById("view-report").innerHTML=`<div class="report-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
    <div style="background:var(--surface);border-radius:11px;padding:18px;border:1px solid var(--border)">
      <div style="font-family:'Space Grotesk';font-weight:700;font-size:13px;margin-bottom:14px;color:var(--text)">ğŸ“Š Progress</div>
      ${Object.entries(STATUS).map(([k,sv])=>{const c=tasks.filter(t=>t.status===k).length,p=tasks.length?(c/tasks.length)*100:0;return`<div style="margin-bottom:11px"><div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="font-size:12px;color:${sv.color};font-weight:600">${sv.label}</span><span style="font-size:11px;color:var(--muted)">${c} (${Math.round(p)}%)</span></div><div class="pb"><div class="pb-fill" style="background:${sv.color};width:${p}%"></div></div></div>`;}).join("")}
    </div>
    <div style="background:var(--surface);border-radius:11px;padding:18px;border:1px solid var(--border)">
      <div style="font-family:'Space Grotesk';font-weight:700;font-size:13px;margin-bottom:14px;color:var(--text)">ğŸš§ Blockers</div>
      ${!bl.length?`<div style="color:#059669;font-size:13px;background:#05966911;border-radius:8px;padding:14px;text-align:center">ğŸ‰ No blockers!</div>`:bl.map(t=>`<div style="background:#dc262611;border:1px solid #dc262633;border-radius:8px;padding:9px;margin-bottom:7px"><div style="font-weight:600;font-size:12px;color:#f87171">${esc(t.title)}</div><div style="font-size:11px;color:var(--muted);margin-top:2px">ğŸš§ ${esc(t.blocker)}</div></div>`).join("")}
    </div>
    <div style="background:var(--surface);border-radius:11px;padding:18px;border:1px solid var(--border)">
      <div style="font-family:'Space Grotesk';font-weight:700;font-size:13px;margin-bottom:14px;color:var(--text)">ğŸ—£ï¸ Scrum Notes</div>
      ${[["âœ… Yesterday",scrum.yesterday,"#059669"],["ğŸš€ Today",scrum.today,"#3b82f6"],["ğŸš§ Blockers",scrum.blockers,"#dc2626"]].map(([l,v,c])=>`<div style="margin-bottom:10px"><div style="font-size:11px;color:${c};font-weight:700;margin-bottom:3px">${l}</div><div style="font-size:12px;color:${v?"var(--text)":"var(--dim)"};background:var(--bg);border-radius:7px;padding:8px;min-height:30px">${v||"Not filled"}</div></div>`).join("")}
    </div>
    <div style="background:var(--surface);border-radius:11px;padding:18px;border:1px solid var(--border)">
      <div style="font-family:'Space Grotesk';font-weight:700;font-size:13px;margin-bottom:14px;color:var(--text)">â±ï¸ Time Tracked</div>
      ${tasks.filter(t=>getTimerElapsed(t.id)>0).map(t=>`<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border)"><span style="font-size:12px;color:var(--text);flex:1">${esc(t.title)}</span><span style="font-size:12px;color:#06b6d4;font-weight:700;font-family:'Space Grotesk'">${fmtT(getTimerElapsed(t.id))}</span></div>`).join("")}
      ${!tasks.filter(t=>getTimerElapsed(t.id)>0).length?`<div style="color:var(--dim);font-size:12px;text-align:center;padding:14px">Use â–¶ Start to track time.</div>`:""}
      <div style="display:flex;justify-content:space-between;padding:10px 0 0"><span style="font-size:13px;font-weight:600;color:var(--text)">Total</span><span style="font-size:13px;font-weight:700;color:#06b6d4;font-family:'Space Grotesk'">${fmtT(totalTime)}</span></div>
    </div>
  </div>`;
}

// ============================================================
// TASK CRUD
// ============================================================
function openTaskForm(id){
  editingId=id||null;
  document.getElementById("taskModalTitle").textContent=id?"âœï¸ Edit Task":"â• New Task";
  document.getElementById("saveTaskBtn").textContent=id?"Update Task":"Add Task";
  const t=id?tasks.find(x=>x.id===id):null;
  document.getElementById("f_title").value=t?.title||"";
  document.getElementById("f_type").value=t?.type||"Bug";
  document.getElementById("f_priority").value=t?.priority||"MEDIUM";
  document.getElementById("f_status").value=t?.status||"TODO";
  document.getElementById("f_env").value=t?.env||"";
  document.getElementById("f_assignee").value=t?.assignee||"";
  document.getElementById("f_est").value=t?.estimate||"";
  document.getElementById("f_actual").value=t?.actual||"";
  document.getElementById("f_sprint").value=t?.sprint||localStorage.getItem("qa_sprint")||"";
  document.getElementById("f_release").value=t?.release||localStorage.getItem("qa_release")||"";
  document.getElementById("f_blocker").value=t?.blocker||"";
  document.getElementById("f_notes").value=t?.notes||"";
  document.getElementById("taskModal").classList.remove("hidden");
  setTimeout(()=>document.getElementById("f_title").focus(),80);
}
function saveTask(){
  const title=document.getElementById("f_title").value.trim();
  if(!title){document.getElementById("f_title").style.borderColor="#dc2626";document.getElementById("f_title").focus();return;}
  document.getElementById("f_title").style.borderColor="";
  const ex=editingId?tasks.find(t=>t.id===editingId):null;
  const task={id:editingId||Date.now(),title,type:document.getElementById("f_type").value,priority:document.getElementById("f_priority").value,status:document.getElementById("f_status").value,env:document.getElementById("f_env").value.trim(),assignee:document.getElementById("f_assignee").value.trim(),estimate:document.getElementById("f_est").value.trim(),actual:document.getElementById("f_actual").value.trim(),sprint:document.getElementById("f_sprint").value.trim(),release:document.getElementById("f_release").value.trim(),blocker:document.getElementById("f_blocker").value.trim(),notes:document.getElementById("f_notes").value.trim(),timerTotal:ex?.timerTotal||0,createdAt:ex?.createdAt||new Date().toLocaleTimeString(),lastModified:Date.now()};
  tasks=editingId?tasks.map(t=>t.id===editingId?task:t):[...tasks,task];
  if(!TM[task.id])TM[task.id]={elapsed:task.timerTotal,state:"idle",startedAt:null};
  save("qa_tasks",tasks);markDirty();closeModal("taskModal");renderAll();
}
function delTask(id){
  if(confirm("Delete this task?")){
    tasks=tasks.filter(t=>t.id!==id);
    save("qa_tasks",tasks);markDirty();renderAll();
  }
}
function updateStatus(id,status){
  tasks=tasks.map(t=>t.id==id?{...t,status,lastModified:Date.now()}:t);
  save("qa_tasks",tasks);markDirty();renderCurrent();
}

// ============================================================
// TABS
// ============================================================
function switchTab(tab){
  activeTab=tab;
  ["board","list","weekly","bugs","charts","report"].forEach(t=>{
    document.getElementById("view-"+t)?.classList.toggle("hidden",t!==tab);
    document.getElementById("tab-"+t)?.classList.toggle("active",t===tab);
  });
  renderCurrent();
}
function renderCurrent(){renderStats();if(activeTab==="board")renderBoard();else if(activeTab==="list")renderList();else if(activeTab==="weekly")renderWeekly();else if(activeTab==="bugs")renderBugsView();else if(activeTab==="charts")renderCharts();else if(activeTab==="report")renderReport();}
function renderAll(){renderCurrent();}

// ============================================================
// SCRUM
// ============================================================
function openScrum(){
  document.getElementById("scrumDate").textContent=getToday();
  document.getElementById("s_yesterday").value=scrum.yesterday;
  document.getElementById("s_today").value=scrum.today;
  document.getElementById("s_blockers").value=scrum.blockers;
  document.querySelectorAll(".mood-btn").forEach(b=>b.classList.toggle("active",b.textContent===scrum.mood));
  document.getElementById("scrumModal").classList.remove("hidden");
}
function saveScrumData(){
  scrum.yesterday=document.getElementById("s_yesterday").value;
  scrum.today=document.getElementById("s_today").value;
  scrum.blockers=document.getElementById("s_blockers").value;
  scrum.lastModified=Date.now();
  save("qa_scrum_"+dk(), scrum);
  closeModal("scrumModal");
  renderCurrent();
  markDirty();
}
function setMood(m){scrum.mood=m;scrum.lastModified=Date.now();document.querySelectorAll(".mood-btn").forEach(b=>b.classList.toggle("active",b.textContent===m));}

// ============================================================
// BUGS
// ============================================================
function openBugModal(){renderBugListModal();document.getElementById("bugModal").classList.remove("hidden");}
function renderBugListModal(){
  const el=document.getElementById("bugListInModal");if(!el)return;
  if(!bugs.length){el.innerHTML=`<div style="color:var(--dim);text-align:center;padding:18px">No bugs yet.</div>`;return;}
  el.innerHTML=`<div style="background:var(--bg);border-radius:9px;border:1px solid var(--border);overflow:auto">
    <table><thead><tr>${["Bug","Severity","Status","Steps","Date","âœ•"].map(h=>`<th>${h}</th>`).join("")}</tr></thead>
    <tbody>${bugs.map(b=>`<tr>
      <td style="color:var(--text);font-weight:500">${esc(b.title)}</td>
      <td><span class="sev-${b.severity}" style="font-size:11px">${b.severity}</span></td>
      <td><select onchange="updBugSt(${b.id},this.value)" style="background:${BSTC[b.status]}22;color:${BSTC[b.status]};border:1px solid ${BSTC[b.status]}55;border-radius:5px;padding:2px 6px;font-size:11px;font-weight:700;cursor:pointer;font-family:inherit">${["OPEN","IN_FIX","FIXED","CLOSED","REOPEN"].map(s=>`<option value="${s}" ${b.status===s?"selected":""}>${s}</option>`).join("")}</select></td>
      <td style="font-size:10px;color:var(--muted);max-width:160px">${esc((b.steps||"").substring(0,60))}</td>
      <td style="font-size:10px;color:var(--dim)">${b.date}</td>
      <td><button class="btn" onclick="delBug(${b.id})" style="background:#dc262622;color:#f87171;padding:2px 7px;font-size:10px">ğŸ—‘</button></td>
    </tr>`).join("")}</tbody></table></div>`;
}
function addBug(){
  const title=document.getElementById("b_title").value.trim();if(!title){document.getElementById("b_title").focus();return;}
  const bug={id:Date.now(),title,severity:document.getElementById("b_severity").value,status:document.getElementById("b_status").value,steps:document.getElementById("b_steps").value.trim(),date:new Date().toLocaleDateString("en-IN"),lastModified:Date.now()};
  bugs.push(bug);
  save("qa_bugs",bugs);markDirty();
  ["b_title","b_steps"].forEach(id=>{document.getElementById(id).value="";});
  document.getElementById("b_severity").value="MEDIUM";document.getElementById("b_status").value="OPEN";
  renderBugListModal();renderCurrent();
}
function delBug(id){if(confirm("Delete bug?")){bugs=bugs.filter(b=>b.id!==id);save("qa_bugs",bugs);markDirty();renderBugListModal();renderCurrent();}}
function updBugSt(id,st){bugs=bugs.map(b=>b.id==id?{...b,status:st,lastModified:Date.now()}:b);save("qa_bugs",bugs);markDirty();renderCurrent();}

// ============================================================
// BUG IMPORT â€” Parse pasted text from spreadsheet
// ============================================================
function openImportBugs(){
  document.getElementById("importPasteArea").value="";
  document.getElementById("importPreview").classList.add("hidden");
  document.getElementById("sheetLoadStatus").textContent="";
  const nameEl = document.getElementById("sheetNameLabel");
  if(nameEl) nameEl.textContent = localStorage.getItem("qa_name")||"Kunal";
  setImportTab(importTab);
  document.getElementById("importModal").classList.remove("hidden");
}

function setImportTab(tab){
  importTab = tab;
  document.getElementById("import-paste-tab").classList.toggle("hidden", tab!=="paste");
  document.getElementById("import-sheet-tab").classList.toggle("hidden", tab!=="sheet");
  document.getElementById("itab-paste").style.background = tab==="paste"?"#1e40af":"transparent";
  document.getElementById("itab-paste").style.color = tab==="paste"?"#fff":"var(--dim)";
  document.getElementById("itab-sheet").style.background = tab==="sheet"?"#059669":"transparent";
  document.getElementById("itab-sheet").style.color = tab==="sheet"?"#fff":"var(--dim)";
  document.getElementById("importPreview").classList.add("hidden");
}

// Parse the concatenated bug text format from spreadsheet copy-paste
// Format: StatusSeverityTitle...attachments...TesterName
// Example: "BuggedMediumStore- Free tag is misaligned...KunalBuggedHigh..."
function parseBugText(raw){
  const parsed = [];
  
  // Strategy: split on known status keywords to find bug boundaries
  // Statuses seen: "Bugged", "Bug verified/QA Pass", "Bug verified", "Reopened"
  const STATUS_PATTERNS = [
    "Bug verified/QA Pass",
    "Bug verified",
    "Bugged",
    "Reopened",
    "Open",
  ];
  
  // Build a regex that splits on status keywords
  const statusRegex = /(Bugged|Bug verified\/QA Pass|Bug verified|Reopened)/g;
  
  // Split the text by these status markers
  const parts = raw.split(statusRegex).filter(s => s.trim().length > 0);
  
  let i = 0;
  while(i < parts.length){
    const part = parts[i].trim();
    
    // Check if this part is a status keyword
    const isStatus = STATUS_PATTERNS.some(sp => part === sp || part.startsWith(sp));
    if(!isStatus){ i++; continue; }
    
    const bugStatus = part;
    const rest = parts[i+1] ? parts[i+1].trim() : "";
    i += 2;
    if(!rest) continue;
    
    // Parse severity from start of rest: Critical/High/Medium/Low/Urgent
    let severity = "MEDIUM";
    let remainder = rest;
    const sevMatch = rest.match(/^(Critical|Urgent|High|Medium|Low)/i);
    if(sevMatch){
      const s = sevMatch[1].toUpperCase();
      severity = s === "URGENT" ? "CRITICAL" : ["CRITICAL","HIGH","MEDIUM","LOW"].includes(s) ? s : "MEDIUM";
      remainder = rest.substring(sevMatch[0].length).trim();
    }
    
    // The title is the text up to any image filename (xxx.png, xxx.jpg) or a long ID (hex string 20+ chars) or assignee name
    // Remove image filenames and hex IDs
    let title = remainder;
    title = title.replace(/[a-f0-9]{20,}/gi, "").trim(); // remove hex IDs
    title = title.replace(/\S+\.(png|jpg|jpeg|gif|webp)/gi, "").trim(); // remove image filenames
    
    // The assignee is usually the last "word(s)" at the end before next chunk
    // Try to extract it: it's typically a name like "Kunal", "Aswin Murali", "Gokul Kennady", etc.
    // Names are 1-3 words with capital first letters
    const nameMatch = title.match(/([A-Z][a-z]+(?: [A-Z][a-z]+){0,2})\s*$/);
    let assignee = "";
    if(nameMatch && nameMatch[1].length > 2 && nameMatch[1].length < 40){
      assignee = nameMatch[1];
      title = title.substring(0, title.length - nameMatch[0].length).trim();
    }
    
    // Clean up title
    title = title.replace(/\s+/g," ").trim();
    if(title.length < 3) continue; // skip noise
    
    // Map status to our OPEN/REOPEN
    let mappedStatus = "OPEN";
    if(bugStatus.includes("verified") || bugStatus.includes("QA Pass")) mappedStatus = "FIXED";
    else if(bugStatus === "Reopened") mappedStatus = "REOPEN";
    
    parsed.push({title, severity, status: mappedStatus, assignee, steps: ""});
  }
  
  return parsed;
}

function previewImport(){
  const raw = document.getElementById("importPasteArea").value.trim();
  if(!raw){ alert("Please paste bug text first!"); return; }
  
  const parsed = parseBugText(raw);
  pendingImportBugs = parsed;
  showImportPreview(parsed);
}

function showImportPreview(parsed){
  const previewEl = document.getElementById("importPreview");
  const listEl = document.getElementById("previewList");
  const countEl = document.getElementById("previewCount");
  
  if(!parsed.length){
    listEl.innerHTML=`<div style="color:#f87171;padding:12px;background:#dc262611;border-radius:8px">No bugs could be parsed. Try selecting and copying just the bug rows from your spreadsheet (not headers).</div>`;
    countEl.textContent = "0";
  } else {
    countEl.textContent = parsed.length;
    listEl.innerHTML = parsed.map((b,i)=>`
      <div class="bug-import-row">
        <span class="sev-${b.severity}" style="font-size:11px;flex-shrink:0">${b.severity}</span>
        <span style="flex:1;color:var(--text)">${esc(b.title)}</span>
        <span style="font-size:10px;color:${BSTC[b.status]||"#6b7280"};font-weight:700;flex-shrink:0">${b.status}</span>
        ${b.assignee?`<span style="font-size:10px;color:var(--dim);flex-shrink:0">${esc(b.assignee)}</span>`:""}
        <button class="tbtn" onclick="pendingImportBugs.splice(${i},1);showImportPreview(pendingImportBugs)" style="background:#dc262622;color:#f87171;flex-shrink:0">âœ•</button>
      </div>`).join("");
  }
  
  previewEl.classList.remove("hidden");
}

function confirmImport(){
  if(!pendingImportBugs.length){closeModal("importModal");return;}
  const today = new Date().toLocaleDateString("en-IN");
  const newBugs = pendingImportBugs.map(b=>({
    id: Date.now() + Math.random(),
    title: b.title,
    severity: b.severity,
    status: b.status,
    steps: b.steps||"",
    assignee: b.assignee||"",
    date: today,
    lastModified: Date.now(),
    imported: true
  }));
  bugs = mergeBugs(bugs, newBugs);
  save("qa_bugs", bugs);
  markDirty();
  renderAll();
  closeModal("importModal");
  showSyncBar(`âœ… Imported ${newBugs.length} bugs!`);
}

// Load bugs from Google Sheet (public CSV export)
async function loadSheetBugs(){
  const urlInput = document.getElementById("sheetUrlInput").value.trim();
  const myName = (localStorage.getItem("qa_name")||"Kunal").trim().toLowerCase();
  const statusEl = document.getElementById("sheetLoadStatus");
  const btn = document.getElementById("loadSheetBtn");
  
  if(!urlInput){ statusEl.textContent = "âš ï¸ Please enter a sheet URL"; return; }
  
  // Extract sheet ID
  const idMatch = urlInput.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
  if(!idMatch){ statusEl.textContent = "âš ï¸ Invalid Google Sheets URL"; return; }
  const sheetId = idMatch[1];
  
  btn.textContent = "â³ Loadingâ€¦";
  btn.disabled = true;
  statusEl.textContent = "Fetching sheet dataâ€¦";
  
  try{
    // Try to fetch as CSV (requires sheet to be publicly accessible)
    // We'll try multiple sheets/tabs
    const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv`;
    
    statusEl.innerHTML = `âš ï¸ Google Sheets requires the sheet to be publicly shared. Please use the <strong>Paste Text</strong> tab instead â€” copy the bug rows from your sheet and paste them there. That method works perfectly!`;
    btn.textContent = "Load Bugs";
    btn.disabled = false;
    
    // Switch to paste tab with helpful message
    setImportTab("paste");
    document.getElementById("importPasteArea").placeholder = 
      `Paste your copied bug rows here.\n\nHow to copy from Google Sheet:\n1. Select the bug rows (not headers)\n2. Ctrl+C / Cmd+C\n3. Come back here and paste (Ctrl+V)\n\nYour bugs with "Bugged" or "Reopened" status will be parsed automatically!`;
    
  }catch(e){
    statusEl.textContent = "âŒ Failed to load sheet: " + e.message;
    btn.textContent = "Load Bugs";
    btn.disabled = false;
  }
}

// ============================================================
// SCRATCH
// ============================================================
function openScratch(){
  document.getElementById("scratchText").value=scratch;
  updScratchCnt();
  document.getElementById("scratchModal").classList.remove("hidden");
}
function updScratchCnt(){const v=document.getElementById("scratchText")?.value||"";const el=document.getElementById("scratchCount");if(el)el.textContent=`${v.length} chars`;}
function clearScratch(){if(confirm("Clear notes?")){scratch="";localStorage.setItem("qa_scratch","");document.getElementById("scratchText").value="";updScratchCnt();markDirty();}}

// ============================================================
// REMINDER
// ============================================================
var remInt=null;
function scheduleReminder(){
  const val=document.getElementById("reminderTime")?.value||"18:00";
  localStorage.setItem("qa_reminder_time",val);
  if(remInt)clearInterval(remInt);
  remInt=setInterval(()=>{
    const now=new Date(),cur=now.getHours().toString().padStart(2,"0")+":"+now.getMinutes().toString().padStart(2,"0");
    if(cur===val){document.getElementById("reminderBar").classList.remove("hidden");if(Notification?.permission==="granted")new Notification("ğŸ§ª QA Tracker â€” EOD Time!",{body:"Generate your daily report!"});}
  },30000);
}

// ============================================================
// THEME
// ============================================================
function toggleTheme(){isLight=!isLight;localStorage.setItem("qa_theme",isLight?"light":"dark");document.body.classList.toggle("light",isLight);document.getElementById("themeBtn").textContent=isLight?"â˜€ï¸ Light":"ğŸŒ™ Dark";}

// ============================================================
// EOD
// ============================================================
function openEOD(){
  const s=getStats(),pct=s.total?Math.round(s.done/s.total*100):0;
  document.getElementById("eodDateTime").textContent=`${getToday()} Â· ${getTime()}`;
  document.getElementById("eod_name").value=localStorage.getItem("qa_name")||"";
  document.getElementById("eod_mgr").value=localStorage.getItem("qa_mgr")||"";
  document.getElementById("eod_notes").value="";
  document.getElementById("eodStats").innerHTML=[{l:"âœ… Done",v:s.done,c:"#059669"},{l:"âš¡ Progress",v:s.prog,c:"#d97706"},{l:"ğŸ“‹ Remaining",v:s.remaining,c:"#7c3aed"},{l:"ğŸš§ Blocked",v:s.blocked,c:"#dc2626"},{l:"ğŸ› Bugs",v:s.openBugs,c:"#f97316"},{l:"ğŸ“Š Complete",v:pct+"%",c:"#3b82f6"}]
    .map(x=>`<div style="background:#0f172a66;border-radius:9px;padding:8px 15px;border:1px solid #334155;text-align:center"><div style="font-size:17px;font-weight:700;color:${x.c};font-family:'Space Grotesk'">${x.v}</div><div style="font-size:10px;color:#64748b;margin-top:1px">${x.l}</div></div>`).join("");
  updateEOD();document.getElementById("eodModal").classList.remove("hidden");
}
function setRTab(t){
  rTab=t;
  document.getElementById("rtab-email").style.background=t==="email"?"#1e40af":"transparent";
  document.getElementById("rtab-email").style.color=t==="email"?"#fff":"var(--dim)";
  document.getElementById("rtab-whatsapp").style.background=t==="whatsapp"?"#059669":"transparent";
  document.getElementById("rtab-whatsapp").style.color=t==="whatsapp"?"#fff":"var(--dim)";
  document.getElementById("rFmtLabel").textContent=t==="email"?"ğŸ“§ Paste into Gmail / Outlook":"ğŸ’¬ Paste into WhatsApp / Slack";
  updateEOD();
}
function updateEOD(){const el=document.getElementById("rptPreview");if(!el)return;el.textContent=rTab==="email"?buildEmail():buildWA();}
function buildEmail(){
  const name=document.getElementById("eod_name")?.value||"QA Engineer",mgr=document.getElementById("eod_mgr")?.value||"Team",note=document.getElementById("eod_notes")?.value||"";
  const sp=localStorage.getItem("qa_sprint")||"",rl=localStorage.getItem("qa_release")||"";
  const done=tasks.filter(t=>t.status==="DONE"),prog=tasks.filter(t=>t.status==="IN_PROGRESS"||t.status==="TESTING"),todo=tasks.filter(t=>t.status==="TODO"),blk=tasks.filter(t=>t.blocker&&t.status!=="DONE"),ob=bugs.filter(b=>b.status==="OPEN"||b.status==="REOPEN");
  const tot=tasks.length,pct=tot?Math.round(done.length/tot*100):0,totalTime=fmtT(tasks.reduce((a,t)=>a+getTimerElapsed(t.id),0));
  const tl=t=>`  â€¢ [${t.type}] ${t.title}${t.env?" ("+t.env+")":""}${t.actual?" â€” "+t.actual:""}${getTimerElapsed(t.id)>0?" â± "+fmtT(getTimerElapsed(t.id)):""}${t.notes?"\n      â”” "+t.notes:""}`;
  return`Subject: EOD Report â€” QA Update | ${getToday()}${sp?" | "+sp:""}${rl?" | "+rl:""}

Hi ${mgr},

Please find my End of Day QA summary for ${getToday()}.${sp?"\nSprint: "+sp:""}${rl?"  Release: "+rl:""}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Š DAILY SUMMARY
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  Total Tasks    : ${tot}
  âœ… Completed   : ${done.length} (${pct}%)
  âš¡ In Progress  : ${prog.length}
  ğŸ“‹ Remaining   : ${todo.length}
  ğŸš§ Blocked     : ${blk.length}
  ğŸ› Open Bugs   : ${ob.length}
  â± Time Logged  : ${totalTime}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ… COMPLETED TODAY (${done.length})
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
${done.length?done.map(tl).join("\n"):"  â€” None completed today"}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âš¡ IN PROGRESS / TESTING (${prog.length})
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
${prog.length?prog.map(tl).join("\n"):"  â€” None in progress"}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“‹ CARRY FORWARD TO TOMORROW (${todo.length})
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
${todo.length?todo.map(tl).join("\n"):"  â€” All tasks addressed!"}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸš§ BLOCKERS
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
${blk.length?blk.map(t=>`  â€¢ ${t.title}\n      â”” ${t.blocker}`).join("\n"):"  âœ… No blockers today!"}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ› OPEN BUGS (${ob.length})
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
${ob.length?ob.map(b=>`  â€¢ [${b.severity}] ${b.title}${b.assignee?" â€” "+b.assignee:""}`).join("\n"):"  âœ… No open bugs!"}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ—£ï¸ SCRUM NOTES
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  Today     : ${scrum.today||"â€”"}
  Blockers  : ${scrum.blockers||"None"}
${note?`\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ“ NOTES\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n${note}\n`:""}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Thanks & Regards,
${name}
Generated at ${getTime()}`;
}
function buildWA(){
  const name=document.getElementById("eod_name")?.value||"QA Engineer",note=document.getElementById("eod_notes")?.value||"",sp=localStorage.getItem("qa_sprint")||"";
  const date=new Date().toLocaleDateString("en-IN",{day:"2-digit",month:"short",year:"numeric"});
  const done=tasks.filter(t=>t.status==="DONE"),prog=tasks.filter(t=>t.status==="IN_PROGRESS"||t.status==="TESTING"),todo=tasks.filter(t=>t.status==="TODO"),blk=tasks.filter(t=>t.blocker&&t.status!=="DONE"),ob=bugs.filter(b=>b.status==="OPEN"||b.status==="REOPEN");
  const tot=tasks.length,pct=tot?Math.round(done.length/tot*100):0;
  return`*ğŸ“‹ EOD QA Report â€” ${date}*${sp?" | *"+sp+"*":""}
*QA:* ${name}

*ğŸ“Š Summary*
âœ… Done: ${done.length}/${tot} (${pct}%)
âš¡ In Progress: ${prog.length}  ğŸ“‹ Remaining: ${todo.length}
ğŸš§ Blocked: ${blk.length}  ğŸ› Open Bugs: ${ob.length}
â± Time: ${fmtT(tasks.reduce((a,t)=>a+getTimerElapsed(t.id),0))}

*âœ… Completed*
${done.length?done.map(t=>`â€¢ [${t.type}] ${t.title}`).join("\n"):"â€¢ None"}

*âš¡ In Progress*
${prog.length?prog.map(t=>`â€¢ ${t.title}`).join("\n"):"â€¢ None"}

*ğŸ“‹ Tomorrow*
${todo.length?todo.map(t=>`â€¢ ${t.title}`).join("\n"):"â€¢ All clear! ğŸ‰"}

*ğŸš§ Blockers*
${blk.length?blk.map(t=>`â€¢ ${t.title}: ${t.blocker}`).join("\n"):"âœ… None!"}

*ğŸ› Open Bugs*
${ob.length?ob.map(b=>`â€¢ [${b.severity}] ${b.title}${b.assignee?" â€” "+b.assignee:""}`).join("\n"):"âœ… None!"}
${note?`\n*ğŸ“ Notes*\n${note}`:""}
${getTime()} | Good Day`;
}

function copyReport(){
  const text=rTab==="email"?buildEmail():buildWA();
  const ok=()=>{["copyBtn","copyBtn2"].forEach(id=>{const b=document.getElementById(id);if(!b)return;b.textContent="âœ… Copied!";b.style.background="#059669";setTimeout(()=>{b.textContent=id==="copyBtn"?"ğŸ“‹ Copy":"ğŸ“‹ Copy & Send to Manager";b.style.background=id==="copyBtn"?"#1e40af":"linear-gradient(135deg,#f59e0b,#ef4444)";},3000);});};
  if(navigator.clipboard?.writeText){navigator.clipboard.writeText(text).then(ok).catch(()=>fbCopy(text,ok));}else fbCopy(text,ok);
}
function fbCopy(text,ok){const ta=document.createElement("textarea");ta.value=text;ta.style.cssText="position:fixed;top:0;left:0;width:2px;height:2px;opacity:0";document.body.appendChild(ta);ta.focus();ta.select();ta.setSelectionRange(0,999999);try{const r=document.execCommand("copy");document.body.removeChild(ta);r?ok():showManual(text);}catch(e){document.body.removeChild(ta);showManual(text);}}
function showManual(text){document.getElementById("manualBox").classList.remove("hidden");document.getElementById("manualText").value=text;document.getElementById("manualText").select();}
function downloadRpt(){const text=rTab==="email"?buildEmail():buildWA();const a=document.createElement("a");a.href=URL.createObjectURL(new Blob([text],{type:"text/plain"}));a.download=`QA_EOD_${dk()}.txt`;a.click();}

// ============================================================
// MODAL
// ============================================================
function closeModal(id){document.getElementById(id)?.classList.add("hidden");}
["taskModal","scrumModal","bugModal","scratchModal","eodModal","importModal"].forEach(id=>{
  document.getElementById(id)?.addEventListener("click",function(e){if(e.target===this)this.classList.add("hidden");});
});
document.addEventListener("keydown",e=>{
  if(e.key==="Escape")["taskModal","scrumModal","bugModal","scratchModal","eodModal","importModal"].forEach(id=>closeModal(id));
  if(e.key==="Enter"&&document.activeElement?.id==="f_title")saveTask();
});

scheduleReminder();

// ============================================================
// MOBILE NAV
// ============================================================
function openMobNav(){
  const nav = document.getElementById('mobileNav');
  // Sync values from desktop inputs to mobile inputs
  const nameEl = document.getElementById('myNameInputMob');
  if(nameEl) nameEl.value = localStorage.getItem('qa_name')||'';
  const spEl = document.getElementById('sprintInputMob');
  if(spEl) spEl.value = localStorage.getItem('qa_sprint')||'';
  const rlEl = document.getElementById('releaseInputMob');
  if(rlEl) rlEl.value = localStorage.getItem('qa_release')||'';
  const rtEl = document.getElementById('reminderTimeMob');
  if(rtEl) rtEl.value = localStorage.getItem('qa_reminder_time')||'18:00';
  if(nav) nav.style.display = 'block';
  document.body.style.overflow = 'hidden';
}
function closeMobNav(){
  const nav = document.getElementById('mobileNav');
  if(nav) nav.style.display = 'none';
  document.body.style.overflow = '';
}

// Override setCloud to also update mobile indicators
const _origSetCloud = setCloud;
window.setCloud = function(state, msg){
  _origSetCloud(state, msg);
  const mobDot = document.getElementById('cloudDotMob');
  const mobLbl = document.getElementById('cloudLabelMob');
  if(mobDot) mobDot.className = 'cloud-dot ' + (state==='ok'?'cloud-ok':state==='err'?'cloud-err':'cloud-sync');
  if(mobLbl) mobLbl.textContent = msg;
};

// Override setAutoSyncStatus for mobile too
const _origSetAutoSync = setAutoSyncStatus;
window.setAutoSyncStatus = function(active){
  _origSetAutoSync(active);
  const dot = document.getElementById('autoSyncDotMob');
  const lbl = document.getElementById('autoSyncLabelMob');
  if(dot) dot.className = 'cloud-dot ' + (active?'sync-pulse':'cloud-ok');
  if(lbl) lbl.textContent = active?'Syncingâ€¦':'Auto-sync: ON';
};

// Show/hide elements based on screen size
function applyMobileLayout(){
  const isMob = window.innerWidth <= 768;
  const mobMenu = document.querySelector('.mob-menu');
  if(mobMenu) mobMenu.style.display = isMob ? 'flex' : 'none';
  const hdrBtns = document.querySelector('.hdr-btns');
  if(hdrBtns) hdrBtns.style.display = isMob ? 'none' : 'flex';
  const ctrlStrip = document.querySelector('.ctrl-strip');
  if(ctrlStrip) ctrlStrip.style.display = isMob ? 'none' : 'flex';
}
window.addEventListener('resize', applyMobileLayout);
applyMobileLayout();

// Update lastSyncInfo in mobile overlay too
const _origSyncMerge = syncAndMerge;
const _origApplyRemote = applyRemoteData;

</script>
</body>
</html>
